#!/usr/bin/env python3
"""
å¹£å®‰ DUSKUSDT æ™ºèƒ½ç›£æ§ç³»çµ± - å–®æ¬¡æƒæç‰ˆ
å°ˆç‚º GitHub Actions å„ªåŒ–
"""

import os
import time
import random
import requests
import json
from datetime import datetime
from binance.client import Client

# ========== é…ç½®åƒæ•¸ ==========
SYMBOL = "DUSKUSDT"
TIMEFRAME = "1m"
ALERT_VOLUME_RATIO = 3.0
ALERT_ORDER_RATIO = 0.6

# ========== Telegram é€šçŸ¥ ==========
def send_telegram_alert(alert_type, data):
    """ç™¼é€ Telegram è­¦å ±"""
    token = os.getenv('TG_TOKEN')
    chat_id = os.getenv('TG_CHAT_ID')
    
    if not token or not chat_id:
        print("âŒ ç¼ºå°‘ Telegram é…ç½®")
        return False
    
    try:
        if alert_type == "BUY_PRESSURE":
            message = f"""ğŸš¨ <b>å¤§é‡è²·ç›¤åµæ¸¬ - DUSKUSDT</b>

ğŸ“‰ é™°ç·šä¸‹è·Œä¸­å‡ºç¾å¤§é‡è²·å–®
ğŸ’° åƒ¹æ ¼ï¼š{data['price']} USDT
ğŸ“Š æˆäº¤é‡ï¼š{data['volume']:.0f} DUSK
âš¡ è²·å–®æ¯”ä¾‹ï¼š{data['buy_ratio']:.1%}
ğŸ•’ æ™‚é–“ï¼š{data['time']}"""
            
        elif alert_type == "SELL_PRESSURE":
            message = f"""ğŸš¨ <b>å¤§é‡è³£ç›¤å‡ºé€ƒ - DUSKUSDT</b>

ğŸ“ˆ é™½ç·šä¸Šæ¼²ä¸­å‡ºç¾å¤§é‡è³£å–®
ğŸ’° åƒ¹æ ¼ï¼š{data['price']} USDT
ğŸ“Š æˆäº¤é‡ï¼š{data['volume']:.0f} DUSK
âš¡ è³£å–®æ¯”ä¾‹ï¼š{data['sell_ratio']:.1%}
ğŸ•’ æ™‚é–“ï¼š{data['time']}"""
        
        elif alert_type == "SCAN_REPORT":
            message = f"""ğŸ“Š <b>DUSKUSDT æƒæå ±å‘Š</b>

ğŸ’° ç•¶å‰åƒ¹æ ¼ï¼š{data['price']} USDT
ğŸ“ˆ æˆäº¤é‡ï¼š{data['volume']:.0f} DUSK
ğŸŸ¢ è²·å–®æ¯”ä¾‹ï¼š{data['buy_ratio']:.1%}
ğŸ”´ è³£å–®æ¯”ä¾‹ï¼š{data['sell_ratio']:.1%}
ğŸ¯ Kç·šç‹€æ…‹ï¼š{data['candle']}
ğŸ•’ æƒææ™‚é–“ï¼š{data['time']}"""
        
        else:
            message = f"ğŸ“¡ {data.get('message', 'ç³»çµ±æ›´æ–°')}"
        
        url = f"https://api.telegram.org/bot{token}/sendMessage"
        payload = {
            "chat_id": chat_id,
            "text": message,
            "parse_mode": "HTML",
            "disable_web_page_preview": True
        }
        
        response = requests.post(url, json=payload, timeout=8)
        return response.status_code == 200
            
    except Exception as e:
        print(f"âŒ Telegram éŒ¯èª¤: {str(e)[:100]}")
        return False

# ========== å¸‚å ´æ•¸æ“šç²å– ==========
def get_market_data():
    """ç²å–å¸‚å ´æ•¸æ“š"""
    try:
        client = Client()
        
        # ç²å–Kç·šæ•¸æ“š
        klines = client.get_klines(
            symbol=SYMBOL,
            interval=TIMEFRAME,
            limit=5
        )
        
        if len(klines) < 2:
            return None
        
        latest = klines[-1]
        previous = klines[-2]
        
        # ç²å–ç•¶å‰åƒ¹æ ¼
        ticker = client.get_symbol_ticker(symbol=SYMBOL)
        
        # ç²å–è¨‚å–®ç°¿
        depth = client.get_order_book(symbol=SYMBOL, limit=5)
        
        return {
            'kline': {
                'open': float(latest[1]),
                'high': float(latest[2]),
                'low': float(latest[3]),
                'close': float(latest[4]),
                'volume': float(latest[5]),
                'prev_volume': float(previous[5]),
                'time': datetime.fromtimestamp(latest[0]/1000).strftime('%H:%M:%S')
            },
            'price': float(ticker['price']),
            'order_book': depth
        }
        
    except Exception as e:
        print(f"âŒ æ•¸æ“šç²å–éŒ¯èª¤: {str(e)[:100]}")
        return None

# ========== å–®æ¬¡æƒæä¸»å‡½æ•¸ ==========
def single_scan():
    """åŸ·è¡Œå–®æ¬¡æƒæ"""
    print("=" * 50)
    print(f"ğŸ” DUSKUSDT å–®æ¬¡æƒæé–‹å§‹")
    print(f"â° æ™‚é–“: {datetime.now().strftime('%H:%M:%S')}")
    print("=" * 50)
    
    # ç²å–æ•¸æ“š
    print("ğŸ“¡ ç²å–å¸‚å ´æ•¸æ“š...")
    market_data = get_market_data()
    
    if not market_data:
        print("âŒ æ•¸æ“šç²å–å¤±æ•—")
        return False
    
    kline = market_data['kline']
    
    # åˆ†ææ•¸æ“š
    is_bearish = kline['close'] < kline['open']
    is_bullish = kline['close'] > kline['open']
    
    volume_ratio = kline['volume'] / kline['prev_volume'] if kline['prev_volume'] > 0 else 1
    
    # è¨ˆç®—è²·è³£å£“åŠ›
    bids = market_data['order_book']['bids'][:3]
    asks = market_data['order_book']['asks'][:3]
    
    buy_pressure = sum(float(bid[1]) for bid in bids)
    sell_pressure = sum(float(ask[1]) for ask in asks)
    total_pressure = buy_pressure + sell_pressure
    
    buy_ratio = buy_pressure / total_pressure if total_pressure > 0 else 0
    sell_ratio = sell_pressure / total_pressure if total_pressure > 0 else 0
    
    # æ‰“å°çµæœ
    candle_type = "é™°ç·š" if is_bearish else "é™½ç·š" if is_bullish else "åå­—ç·š"
    
    print(f"ğŸ’° ç•¶å‰åƒ¹æ ¼: {market_data['price']} USDT")
    print(f"ğŸ“ˆ æˆäº¤é‡æ¯”ç‡: {volume_ratio:.1f}å€")
    print(f"ğŸŸ¢ è²·å–®æ¯”ä¾‹: {buy_ratio:.1%}")
    print(f"ğŸ”´ è³£å–®æ¯”ä¾‹: {sell_ratio:.1%}")
    print(f"ğŸ¯ Kç·šç‹€æ…‹: {candle_type}")
    
    # æª¢æŸ¥è­¦å ±æ¢ä»¶
    alert_triggered = False
    
    # æ¢ä»¶1: é™°ç·š + å¤§é‡è²·å–®
    if is_bearish and volume_ratio > ALERT_VOLUME_RATIO and buy_ratio > ALERT_ORDER_RATIO:
        print("ğŸš¨ è§¸ç™¼: é™°ç·šå¤§é‡è²·ç›¤")
        alert_triggered = send_telegram_alert("BUY_PRESSURE", {
            'price': market_data['price'],
            'volume': kline['volume'],
            'buy_ratio': buy_ratio,
            'time': kline['time']
        })
    
    # æ¢ä»¶2: é™½ç·š + å¤§é‡è³£å–®
    elif is_bullish and volume_ratio > ALERT_VOLUME_RATIO and sell_ratio > ALERT_ORDER_RATIO:
        print("ğŸš¨ è§¸ç™¼: é™½ç·šå¤§é‡è³£ç›¤")
        alert_triggered = send_telegram_alert("SELL_PRESSURE", {
            'price': market_data['price'],
            'volume': kline['volume'],
            'sell_ratio': sell_ratio,
            'time': kline['time']
        })
    
    # å¦‚æœæ²’æœ‰è§¸ç™¼è­¦å ±ï¼Œæ¯5æ¬¡æƒæç™¼é€ä¸€æ¬¡ç‹€æ…‹å ±å‘Š
    else:
        from random import randint
        if randint(1, 5) == 1:  # 20% æ©Ÿç‡ç™¼é€ç‹€æ…‹å ±å‘Š
            send_telegram_alert("SCAN_REPORT", {
                'price': market_data['price'],
                'volume': kline['volume'],
                'buy_ratio': buy_ratio,
                'sell_ratio': sell_ratio,
                'candle': candle_type,
                'time': kline['time']
            })
            print("ğŸ“Š ç™¼é€ç‹€æ…‹å ±å‘Š")
        else:
            print("âœ… æƒæå®Œæˆï¼Œç„¡ç•°å¸¸ä¿¡è™Ÿ")
    
    print("=" * 50)
    print(f"âœ… æƒæå®Œæˆ")
    print("=" * 50)
    
    return True

# ========== ä¸»ç¨‹åº ==========
if __name__ == "__main__":
    try:
        success = single_scan()
        if success:
            exit(0)
        else:
            exit(1)
    except Exception as e:
        print(f"âŒ æƒæéŒ¯èª¤: {e}")
        exit(1)
