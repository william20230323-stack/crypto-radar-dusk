"""
å¹£å®‰ DUSKUSDT å¿«é€Ÿæƒæç‰ˆ - 30ç§’å…§å®Œæˆ
ä¿®æ­£ç‰ˆï¼šç§»é™¤ signalï¼Œé¿å…ç’°å¢ƒå•é¡Œ
"""

import os
import requests
from datetime import datetime
from binance.client import Client
import random
import functools
import errno
import time

# è¶…æ™‚è£é£¾å™¨
def timeout(seconds=25, error_message=os.strerror(errno.ETIME)):
    def decorator(func):
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            import threading
            
            class InterruptableThread(threading.Thread):
                def __init__(self):
                    super().__init__()
                    self.result = None
                    self.exception = None
                
                def run(self):
                    try:
                        self.result = func(*args, **kwargs)
                    except Exception as e:
                        self.exception = e
            
            thread = InterruptableThread()
            thread.start()
            thread.join(seconds)
            
            if thread.is_alive():
                print("â° æƒæè¶…æ™‚ï¼Œå¼·åˆ¶çµæŸ")
                return False
            if thread.exception:
                raise thread.exception
            return thread.result
        
        return wrapper
    return decorator

# ========== é…ç½® ==========
SYMBOL = "DUSKUSDT"
TIMEFRAME = "1m"

# ========== Telegram å¿«é€Ÿé€šçŸ¥ ==========
def quick_telegram(message):
    """å¿«é€Ÿç™¼é€ Telegram"""
    try:
        token = os.getenv('TG_TOKEN')
        chat_id = os.getenv('TG_CHAT_ID')
        if not token or not chat_id:
            print("âš ï¸ æœªè¨­ç½® Telegram ç’°å¢ƒè®Šæ•¸")
            return False
        
        url = f"https://api.telegram.org/bot{token}/sendMessage"
        payload = {
            "chat_id": chat_id,
            "text": message,
            "parse_mode": "HTML"
        }
        response = requests.post(url, json=payload, timeout=3)
        return response.status_code == 200
    except Exception as e:
        print(f"âš ï¸ Telegram ç™¼é€å¤±æ•—: {str(e)[:50]}")
        return False

# ========== ä¸»æƒæ ==========
@timeout(seconds=25)
def quick_scan():
    """å¿«é€Ÿæƒæï¼ˆ25ç§’è¶…æ™‚ï¼‰"""
    print("âš¡ DUSKUSDT å¿«é€Ÿæƒæå•Ÿå‹•")
    print(f"â° æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    try:
        # åˆå§‹åŒ–å¹£å®‰å®¢æˆ¶ç«¯ï¼ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸æˆ–é»˜èªï¼‰
        api_key = os.getenv('BINANCE_API_KEY', '')
        api_secret = os.getenv('BINANCE_API_SECRET', '')
        
        if api_key and api_secret:
            client = Client(api_key, api_secret)
            print("ğŸ”‘ ä½¿ç”¨ API å¯†é‘°é€£æ¥")
        else:
            client = Client()
            print("ğŸ”— ä½¿ç”¨å…¬é–‹ API é€£æ¥")
        
        # 1. ç²å–æœ€æ–°Kç·š
        print("ğŸ“¡ ç²å–Kç·šæ•¸æ“š...")
        klines = client.get_klines(
            symbol=SYMBOL,
            interval=TIMEFRAME,
            limit=2
        )
        
        if len(klines) < 2:
            print("âŒ æ•¸æ“šä¸è¶³")
            return False
        
        latest = klines[-1]
        prev = klines[-2]
        
        # 2. åŸºæœ¬æ•¸æ“š
        open_price = float(latest[1])
        close_price = float(latest[4])
        high_price = float(latest[2])
        low_price = float(latest[3])
        volume = float(latest[5])
        prev_volume = float(prev[5])
        
        # 3. ç•¶å‰åƒ¹æ ¼
        print("ğŸ“ˆ ç²å–ç•¶å‰åƒ¹æ ¼...")
        ticker = client.get_symbol_ticker(symbol=SYMBOL)
        current_price = float(ticker['price'])
        
        # 4. ç°¡å–®åˆ†æ
        is_bearish = close_price < open_price
        is_bullish = close_price > open_price
        is_doji = abs(close_price - open_price) / max(open_price, close_price) < 0.001
        volume_ratio = volume / prev_volume if prev_volume > 0 else 1
        
        # 5. è¨‚å–®ç°¿
        print("ğŸ“Š ç²å–è¨‚å–®ç°¿...")
        depth = client.get_order_book(symbol=SYMBOL, limit=5)
        bids = depth['bids']
        asks = depth['asks']
        
        buy_pressure = sum(float(bid[1]) for bid in bids)
        sell_pressure = sum(float(ask[1]) for ask in asks)
        total = buy_pressure + sell_pressure
        
        buy_ratio = buy_pressure / total if total > 0 else 0
        sell_ratio = sell_pressure / total if total > 0 else 0
        
        # 6. åƒ¹æ ¼è®ŠåŒ–ç™¾åˆ†æ¯”
        price_change_pct = ((current_price - open_price) / open_price * 100) if open_price > 0 else 0
        
        # 7. è¼¸å‡ºçµæœ
        current_time = datetime.now().strftime('%H:%M:%S')
        
        print("\n" + "=" * 50)
        print("ğŸ“Š DUSKUSDT æƒæçµæœ")
        print("=" * 50)
        print(f"ğŸ’° ç•¶å‰åƒ¹æ ¼: {current_price:.6f} USDT")
        print(f"ğŸ“ˆ é–‹ç›¤åƒ¹æ ¼: {open_price:.6f} USDT")
        print(f"ğŸ“‰ åƒ¹æ ¼è®ŠåŒ–: {price_change_pct:+.2f}%")
        print(f"ğŸ“Š æœ€é«˜/æœ€ä½: {high_price:.6f} / {low_price:.6f}")
        print(f"ğŸ“ˆ æˆäº¤é‡æ¯”: {volume_ratio:.1f}å€")
        print(f"ğŸŸ¢ è²·å–®æ¯”ä¾‹: {buy_ratio:.1%}")
        print(f"ğŸ”´ è³£å–®æ¯”ä¾‹: {sell_ratio:.1%}")
        print(f"ğŸ¯ Kç·šé¡å‹: {'é™°ç·š' if is_bearish else 'é™½ç·š' if is_bullish else 'åå­—ç·š'}")
        print(f"ğŸ•’ æƒææ™‚é–“: {current_time}")
        print("=" * 50)
        
        # 8. æª¢æŸ¥è­¦å ±æ¢ä»¶
        alert_sent = False
        
        # è­¦å ±æ¢ä»¶1: é™°ç·šä½†è²·ç›¤å¼·å‹
        if is_bearish and volume_ratio > 3.0 and buy_ratio > 0.6:
            alert_msg = f"ğŸš¨ DUSKUSDT é™°ç·šå¤§é‡è²·ç›¤\n"
            alert_msg += f"ğŸ’° åƒ¹æ ¼: {current_price:.6f}\n"
            alert_msg += f"ğŸ“ˆ æˆäº¤é‡: {volume_ratio:.1f}å€\n"
            alert_msg += f"ğŸŸ¢ è²·å–®æ¯”ä¾‹: {buy_ratio:.1%}\n"
            alert_msg += f"â° æ™‚é–“: {current_time}"
            
            print("ğŸš¨ è§¸ç™¼è­¦å ±: é™°ç·šå¤§é‡è²·ç›¤")
            quick_telegram(alert_msg)
            alert_sent = True
            
        # è­¦å ±æ¢ä»¶2: é™½ç·šä½†è³£ç›¤å¼·å‹
        elif is_bullish and volume_ratio > 3.0 and sell_ratio > 0.6:
            alert_msg = f"ğŸš¨ DUSKUSDT é™½ç·šå¤§é‡è³£ç›¤\n"
            alert_msg += f"ğŸ’° åƒ¹æ ¼: {current_price:.6f}\n"
            alert_msg += f"ğŸ“ˆ æˆäº¤é‡: {volume_ratio:.1f}å€\n"
            alert_msg += f"ğŸ”´ è³£å–®æ¯”ä¾‹: {sell_ratio:.1%}\n"
            alert_msg += f"â° æ™‚é–“: {current_time}"
            
            print("ğŸš¨ è§¸ç™¼è­¦å ±: é™½ç·šå¤§é‡è³£ç›¤")
            quick_telegram(alert_msg)
            alert_sent = True
        
        # 9. éš¨æ©Ÿç‹€æ…‹å ±å‘Šï¼ˆ20%æ©Ÿç‡ï¼‰
        if not alert_sent:
            if random.random() < 0.2:
                status_msg = f"ğŸ“Š DUSKUSDT ç‹€æ…‹å ±å‘Š\n"
                status_msg += f"ğŸ’° åƒ¹æ ¼: {current_price:.6f}\n"
                status_msg += f"ğŸ“ˆ è®ŠåŒ–: {price_change_pct:+.2f}%\n"
                status_msg += f"ğŸŸ¢ è²·ç›¤: {buy_ratio:.1%}\n"
                status_msg += f"â° æ™‚é–“: {current_time}"
                
                print("ğŸ“Š ç™¼é€ç‹€æ…‹å ±å‘Š")
                quick_telegram(status_msg)
            else:
                print("âœ… æƒæå®Œæˆï¼Œç„¡ç•°å¸¸è­¦å ±")
        
        print("âœ… æƒææˆåŠŸå®Œæˆ")
        return True
        
    except Exception as e:
        print(f"âŒ æƒæéŒ¯èª¤: {str(e)[:100]}")
        return False

# ========== ä¸»ç¨‹åº ==========
if __name__ == "__main__":
    print("ğŸš€ DUSKUSDT å¿«é€Ÿæƒæç³»çµ±å•Ÿå‹•")
    print("=" * 50)
    print(f"ğŸ¯ äº¤æ˜“å°: {SYMBOL}")
    print(f"â±ï¸  æ™‚é–“æ¡†æ¶: {TIMEFRAME}")
    print(f"â³ è¶…æ™‚æ™‚é–“: 25ç§’")
    print("=" * 50)
    
    success = quick_scan()
    
    if success:
        print("\nğŸ‰ ä»»å‹™æˆåŠŸå®Œæˆ")
        exit(0)
    else:
        print("\nâŒ ä»»å‹™åŸ·è¡Œå¤±æ•—")
        exit(1)
