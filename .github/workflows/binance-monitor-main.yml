"""
å¹£å®‰ DUSKUSDT å¿«é€Ÿæƒæç‰ˆ - 30ç§’å…§å®Œæˆ
"""

import os
import requests
from datetime import datetime
from binance.client import Client
import signal
import random

# è¶…æ™‚è™•ç†
class TimeoutException(Exception):
    pass

def timeout_handler(signum, frame):
    raise TimeoutException("æƒæè¶…æ™‚")

# ========== é…ç½® ==========
SYMBOL = "DUSKUSDT"
TIMEFRAME = "1m"

# ========== Telegram å¿«é€Ÿé€šçŸ¥ ==========
def quick_telegram(message):
    """å¿«é€Ÿç™¼é€ Telegram"""
    try:
        token = os.getenv('TG_TOKEN')
        chat_id = os.getenv('TG_CHAT_ID')
        if not token or not chat_id:
            return False
        
        url = f"https://api.telegram.org/bot{token}/sendMessage"
        payload = {
            "chat_id": chat_id,
            "text": message,
            "parse_mode": "HTML"
        }
        response = requests.post(url, json=payload, timeout=3)
        return response.status_code == 200
    except:
        return False

# ========== ä¸»æƒæ ==========
def quick_scan():
    """å¿«é€Ÿæƒæ"""
    print("âš¡ DUSKUSDT å¿«é€Ÿæƒæå•Ÿå‹•")
    print(f"â° æ™‚é–“: {datetime.now().strftime('%H:%M:%S')}")
    
    try:
        # è¨­ç½®25ç§’è¶…æ™‚
        signal.signal(signal.SIGALRM, timeout_handler)
        signal.alarm(25)
        
        client = Client()
        
        # 1. ç²å–æœ€æ–°Kç·š
        print("ğŸ“¡ ç²å–Kç·šæ•¸æ“š...")
        klines = client.get_klines(
            symbol=SYMBOL,
            interval=TIMEFRAME,
            limit=2
        )
        
        if len(klines) < 2:
            print("âŒ æ•¸æ“šä¸è¶³")
            return False
        
        latest = klines[-1]
        prev = klines[-2]
        
        # 2. åŸºæœ¬æ•¸æ“š
        open_price = float(latest[1])
        close_price = float(latest[4])
        volume = float(latest[5])
        prev_volume = float(prev[5])
        
        # 3. ç•¶å‰åƒ¹æ ¼
        print("ğŸ“ˆ ç²å–ç•¶å‰åƒ¹æ ¼...")
        ticker = client.get_symbol_ticker(symbol=SYMBOL)
        current_price = float(ticker['price'])
        
        # 4. ç°¡å–®åˆ†æ
        is_bearish = close_price < open_price
        is_bullish = close_price > open_price
        volume_ratio = volume / prev_volume if prev_volume > 0 else 1
        
        # 5. è¨‚å–®ç°¿
        print("ğŸ“Š ç²å–è¨‚å–®ç°¿...")
        depth = client.get_order_book(symbol=SYMBOL, limit=3)
        bids = depth['bids']
        asks = depth['asks']
        
        buy_pressure = sum(float(bid[1]) for bid in bids)
        sell_pressure = sum(float(ask[1]) for ask in asks)
        total = buy_pressure + sell_pressure
        
        buy_ratio = buy_pressure / total if total > 0 else 0
        sell_ratio = sell_pressure / total if total > 0 else 0
        
        # 6. è¼¸å‡ºçµæœ
        current_time = datetime.now().strftime('%H:%M:%S')
        
        print("\n" + "=" * 40)
        print("ğŸ“Š æƒæçµæœ:")
        print(f"ğŸ’° åƒ¹æ ¼: {current_price} USDT")
        print(f"ğŸ“ˆ æˆäº¤é‡: {volume_ratio:.1f}å€")
        print(f"ğŸŸ¢ è²·å–®æ¯”ä¾‹: {buy_ratio:.1%}")
        print(f"ğŸ”´ è³£å–®æ¯”ä¾‹: {sell_ratio:.1%}")
        print(f"ğŸ¯ Kç·š: {'é™°ç·š' if is_bearish else 'é™½ç·š' if is_bullish else 'åå­—ç·š'}")
        print(f"ğŸ•’ æ™‚é–“: {current_time}")
        print("=" * 40)
        
        # 7. æª¢æŸ¥è­¦å ±
        alert_sent = False
        
        if is_bearish and volume_ratio > 3.0 and buy_ratio > 0.6:
            print("ğŸš¨ è§¸ç™¼: é™°ç·šå¤§é‡è²·ç›¤")
            quick_telegram(f"ğŸš¨ é™°ç·šå¤§é‡è²·ç›¤\nåƒ¹æ ¼: {current_price}\nè²·å–®: {buy_ratio:.1%}\næ™‚é–“: {current_time}")
            alert_sent = True
            
        elif is_bullish and volume_ratio > 3.0 and sell_ratio > 0.6:
            print("ğŸš¨ è§¸ç™¼: é™½ç·šå¤§é‡è³£ç›¤")
            quick_telegram(f"ğŸš¨ é™½ç·šå¤§é‡è³£ç›¤\nåƒ¹æ ¼: {current_price}\nè³£å–®: {sell_ratio:.1%}\næ™‚é–“: {current_time}")
            alert_sent = True
        
        # 8. éš¨æ©Ÿç‹€æ…‹å ±å‘Š
        if not alert_sent:
            if random.random() < 0.2:  # 20%æ©Ÿç‡
                print("ğŸ“Š ç™¼é€ç‹€æ…‹å ±å‘Š")
                quick_telegram(f"ğŸ“Š DUSKUSDT ç‹€æ…‹\nåƒ¹æ ¼: {current_price}\næ™‚é–“: {current_time}")
            else:
                print("âœ… æƒæå®Œæˆï¼Œç„¡ç•°å¸¸")
        
        # å–æ¶ˆè¶…æ™‚
        signal.alarm(0)
        print("âœ… æƒææˆåŠŸå®Œæˆ")
        return True
        
    except TimeoutException:
        print("â° æƒæè¶…æ™‚ï¼Œå¼·åˆ¶çµæŸ")
        return False
    except Exception as e:
        print(f"âŒ æƒæéŒ¯èª¤: {str(e)[:100]}")
        return False
    finally:
        # ç¢ºä¿å–æ¶ˆè¶…æ™‚
        signal.alarm(0)

# ========== ä¸»ç¨‹åº ==========
if __name__ == "__main__":
    print("ğŸš€ DUSKUSDT å¿«é€Ÿæƒæç³»çµ±å•Ÿå‹•")
    print("=" * 50)
    
    success = quick_scan()
    
    if success:
        print("\nğŸ‰ ä»»å‹™æˆåŠŸå®Œæˆ")
        exit(0)
    else:
        print("\nâŒ ä»»å‹™åŸ·è¡Œå¤±æ•—")
        exit(1)
