name: DUSKUSDT 5-Minute Monitor

on:
  # è°ƒæ•´ä¸º5åˆ†é’Ÿä¸€æ¬¡ï¼Œé¿å…é¢‘ç‡è¿‡é«˜å¯¼è‡´å†²çª
  schedule:
    - cron: '*/5 * * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean

# ========== å¹¶å‘æ§åˆ¶ ==========
# å¦‚æœè„šæœ¬èƒ½å¿«é€Ÿå®Œæˆï¼ˆ<1åˆ†é’Ÿï¼‰ï¼Œå¯ä»¥å¯ç”¨å¹¶å‘æ§åˆ¶
# å¦‚æœè„šæœ¬éœ€è¦æ›´é•¿æ—¶é—´ï¼Œå»ºè®®æ³¨é‡Šæ‰è¿™éƒ¨åˆ†
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
# =============================

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º4åˆ†é’Ÿï¼Œç¡®ä¿åœ¨ä¸‹æ¬¡è§¦å‘å‰å®Œæˆ
    timeout-minutes: 4
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # æ­¥éª¤2: éªŒè¯æ–‡ä»¶ç»“æ„
      - name: Verify files
        run: |
          echo "âœ… éªŒè¯å…³é”®æ–‡ä»¶..."
          ls -la dusk_monitor.py requirements.txt config.py 2>/dev/null || echo "éƒ¨åˆ†æ–‡ä»¶ä¸å­˜åœ¨"
          echo ""
          echo "ğŸ“‹ Pythonæ–‡ä»¶åˆ—è¡¨:"
          ls *.py 2>/dev/null || echo "æ— Pythonæ–‡ä»¶"
      
      # æ­¥éª¤3: è®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # æ­¥éª¤4: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          python -m pip install --upgrade pip
          
          # å®‰è£…requirements.txtä¸­çš„ä¾èµ–
          if [ -f requirements.txt ]; then
            echo "ä»requirements.txtå®‰è£…..."
            pip install -r requirements.txt
          else
            echo "æœªæ‰¾åˆ°requirements.txtï¼Œå®‰è£…åŸºç¡€ä¾èµ–"
            pip install requests python-dotenv pandas ccxt python-telegram-bot
          fi
          
          # éªŒè¯å·²å®‰è£…çš„åŒ…
          echo "âœ… å·²å®‰è£…çš„åŒ…:"
          pip list | grep -E "(requests|python-dotenv|pandas|ccxt|telegram)"
      
      # æ­¥éª¤5: è¿è¡Œç›‘æ§è„šæœ¬
      - name: Run DUSKUSDT Monitor
        env:
          # è„šæœ¬ä½¿ç”¨çš„ç¯å¢ƒå˜é‡
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TRADE_SYMBOL: ${{ secrets.TRADE_SYM }}
          
          # è°ƒè¯•ç›¸å…³
          DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
          PYTHONUNBUFFERED: '1'
          
          # å¯é€‰ï¼šè®¾ç½®æ—¶åŒº
          TZ: 'UTC'
        run: |
          echo "ğŸš€ å¯åŠ¨DUSKUSDTç›‘æ§..."
          echo "ğŸ“… æ—¶é—´: $(date)"
          echo "ğŸ”„ é¢‘ç‡: 5åˆ†é’Ÿ"
          echo "ğŸ’° äº¤æ˜“å¯¹: $TRADE_SYMBOL"
          echo "ğŸ› è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
          echo ""
          
          # éªŒè¯è„šæœ¬å­˜åœ¨
          if [ ! -f "dusk_monitor.py" ]; then
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°dusk_monitor.py"
            exit 1
          fi
          
          # æ£€æŸ¥è„šæœ¬ä¸­çš„ç¯å¢ƒå˜é‡ä½¿ç”¨
          echo "ğŸ” æ£€æŸ¥è„šæœ¬ç¯å¢ƒå˜é‡å¼•ç”¨..."
          grep -n "os\.getenv\|os\.environ" dusk_monitor.py | head -5 || true
          echo ""
          
          # è¿è¡Œè„šæœ¬å¹¶è®¾ç½®è¶…æ—¶ï¼ˆæœ€å¤š3åˆ†é’Ÿï¼‰
          echo "â–¶ï¸ æ‰§è¡Œç›‘æ§è„šæœ¬..."
          echo "----------------------------------------"
          
          # ä½¿ç”¨timeoutç¡®ä¿è„šæœ¬ä¸ä¼šæ— é™è¿è¡Œ
          timeout 180 python dusk_monitor.py  # 3åˆ†é’Ÿè¶…æ—¶
          
          EXIT_CODE=$?
          echo "----------------------------------------"
          echo ""
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… ç›‘æ§è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          elif [ $EXIT_CODE -eq 124 ]; then
            echo "âš ï¸ ç›‘æ§è„šæœ¬è¶…æ—¶ï¼ˆè¿è¡Œè¶…è¿‡3åˆ†é’Ÿï¼‰"
            echo "å»ºè®®ï¼šæ£€æŸ¥è„šæœ¬é€»è¾‘ï¼Œç¡®ä¿ä¸ä¼šæ— é™å¾ªç¯"
          else
            echo "âŒ ç›‘æ§è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
            echo "è¯·æ£€æŸ¥è„šæœ¬é”™è¯¯ä¿¡æ¯"
          fi
          
          echo "â° å®Œæˆæ—¶é—´: $(date)"
      
      # æ­¥éª¤6: é”™è¯¯å¤„ç†
      - name: Handle Failure
        if: failure()
        run: |
          echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
          echo ""
          echo "å¯èƒ½åŸå› åŠè§£å†³æ–¹æ¡ˆ:"
          echo "1. è„šæœ¬é”™è¯¯ - æ£€æŸ¥Pythonè„šæœ¬è¯­æ³•"
          echo "2. ä¾èµ–ç¼ºå¤± - ç¡®è®¤requirements.txtåŒ…å«æ‰€æœ‰å¿…è¦åŒ…"
          echo "3. ç¯å¢ƒå˜é‡é”™è¯¯ - ç¡®è®¤GitHub Secretsè®¾ç½®æ­£ç¡®"
          echo "4. è¶…æ—¶é—®é¢˜ - è„šæœ¬è¿è¡Œæ—¶é—´è¿‡é•¿"
          echo ""
          echo "ğŸ“‹ è°ƒè¯•å»ºè®®:"
          echo "- æ‰‹åŠ¨è¿è¡Œå·¥ä½œæµå¹¶å¼€å¯debug_mode"
          echo "- åœ¨æœ¬åœ°æµ‹è¯•: python dusk_monitor.py"
          echo "- æ£€æŸ¥è„šæœ¬æ˜¯å¦éœ€è¦ä¿®æ”¹ä¸ºå•æ¬¡æ‰§è¡Œæ¨¡å¼"
      
      # æ­¥éª¤7: æˆåŠŸé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Success Notification
        if: success()
        run: |
          echo "ğŸ‰ ç›‘æ§ä»»åŠ¡å®Œæˆ"
          echo "âœ… æ‰€æœ‰æ­¥éª¤æ‰§è¡ŒæˆåŠŸ"
          echo "ğŸ”„ ä¸‹æ¬¡è¿è¡Œ: 5åˆ†é’Ÿå"
          echo "ğŸ“Š æŸ¥çœ‹è¿è¡Œå†å²è·å–è¯¦ç»†æ—¥å¿—"
