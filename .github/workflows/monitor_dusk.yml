name: 'DUSKUSDT 1-Minute Monitor'

on:
  # å®šæ—¶è§¦å‘ - æ¯åˆ†é’Ÿä¸€æ¬¡
  schedule:
    - cron: '*/1 * * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å¼€å¯è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

# å¹¶å‘æ§åˆ¶ - ç¡®ä¿æ¯åˆ†é’Ÿåªæœ‰ä¸€ä¸ªå®ä¾‹è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv pandas ccxt python-telegram-bot schedule
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run DUSKUSDT Monitor
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TRADE_SYMBOL: ${{ secrets.TRADE_SYMBOL || secrets.TRADE_SYM || 'DUSKUSDT' }}
          DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
          PYTHONUNBUFFERED: '1'
        run: |
          echo "=== DUSKUSDT Cryptocurrency Monitor ==="
          echo "Start time: $(date)"
          echo "Trigger: ${{ github.event_name }}"
          echo "Debug mode: $DEBUG_MODE"
          echo "Trading pair: $TRADE_SYMBOL"
          echo ""
          
          # éªŒè¯ç¯å¢ƒå˜é‡
          if [ -z "$TG_TOKEN" ]; then
            echo "âŒ ERROR: TG_TOKEN not set"
            exit 1
          fi
          
          if [ -z "$TG_CHAT_ID" ]; then
            echo "âŒ ERROR: TG_CHAT_ID not set"
            exit 1
          fi
          
          echo "âœ… Environment variables verified"
          echo ""
          
          # è¿è¡Œè„šæœ¬ï¼Œä½¿ç”¨timeoutç¡®ä¿ä¸ä¼šæ— é™ç­‰å¾…
          # 30ç§’è¶³å¤Ÿæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œç„¶åå¼ºåˆ¶é€€å‡º
          echo "Running monitor script (timeout: 30s)..."
          timeout 30 python dusk_monitor.py
          
          EXIT_CODE=$?
          echo ""
          
          # å¤„ç†ä¸åŒçš„é€€å‡ºä»£ç 
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Script completed successfully"
          elif [ $EXIT_CODE -eq 124 ]; then
            echo "âš ï¸ Script timed out (expected, prevents waiting 55 seconds)"
          else
            echo "âŒ Script failed with exit code: $EXIT_CODE"
            exit $EXIT_CODE
          fi
          
          echo "End time: $(date)"
      
      - name: Handle failure
        if: failure()
        run: |
          echo "âŒ Monitor job failed"
          echo ""
          echo "Possible issues:"
          echo "1. Check for syntax errors in dusk_monitor.py"
          echo "2. Ensure all required Python libraries are installed"
          echo "3. Verify GitHub Secrets are correctly set"
          echo "4. Test locally: python dusk_monitor.py"
      
      - name: Success notification
        if: success()
        run: |
          echo "âœ… Monitor job completed successfully"
          echo "ğŸ”„ Next run: in 1 minute"
