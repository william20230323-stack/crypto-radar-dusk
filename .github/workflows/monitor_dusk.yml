name: DUSK/USDT Multi-Exchange Monitor

on:
  schedule:
    - cron: '*/15 * * * *'
  
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æ¸¬è©¦æ¨¡å¼ï¼ˆä¸ç™¼é€çœŸå¯¦è­¦å ±ï¼‰'
        required: false
        default: 'false'
        type: boolean
  
  push:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - '.github/workflows/**'

env:
  TG_TOKEN: ${{ secrets.TG_TOKEN }}
  TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
  PYTHON_VERSION: '3.9'
  CHECK_INTERVAL: '15'

jobs:
  test-system:
    name: ğŸ” ç³»çµ±æ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: ğŸ è¨­ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… ä¾è³´å®‰è£å®Œæˆ"
      
      - name: ğŸ”§ ç’°å¢ƒè¨ºæ–·
        run: |
          echo "ğŸ”§ ç’°å¢ƒè¨ºæ–·å ±å‘Š"
          echo "================"
          echo "Pythonç‰ˆæœ¬: $(python --version)"
          echo "pipç‰ˆæœ¬: $(pip --version)"
          echo "å·¥ä½œç›®éŒ„: $(pwd)"
          echo "æ–‡ä»¶çµæ§‹:"
          ls -la
          echo ""
          echo "é…ç½®æª¢æŸ¥:"
          if [ -f ".env" ]; then
            echo "âœ… .env æ–‡ä»¶å­˜åœ¨"
            echo "æ–‡ä»¶å¤§å°: $(wc -l < .env) è¡Œ"
          elif [ -f ".env.example" ]; then
            echo "âš ï¸  åªæœ‰ .env.exampleï¼Œè¤‡è£½ç‚º .env"
            cp .env.example .env
          else
            echo "âŒ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"
            echo "TEST_CONFIG=missing" >> $GITHUB_ENV
          fi
          echo ""
          echo "ä¾è³´æª¢æŸ¥:"
          pip list
      
      - name: ğŸ§ª é‹è¡Œæ™ºèƒ½æ¸¬è©¦
        id: run-tests
        run: |
          echo "ğŸ§ª æ™ºèƒ½æ¸¬è©¦ç³»çµ±å•Ÿå‹•"
          echo "=================="
          
          # æª¢æŸ¥æ¸¬è©¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "test_all.py" ] && [ ! -d "tests/" ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°æ¨™æº–æ¸¬è©¦æ–‡ä»¶ï¼Œå‰µå»ºåŸºæœ¬æ¸¬è©¦..."
            cat > quick_test.py << 'EOF'
import sys
import os

def test_dependencies():
    """æ¸¬è©¦ä¾è³´åº«"""
    try:
        import requests
        print("âœ… requests åº«æ­£å¸¸")
        return True
    except ImportError:
        print("âŒ ç¼ºå°‘ requests åº«")
        return False

def test_config():
    """æ¸¬è©¦é…ç½®æ–‡ä»¶"""
    config_files = ['.env', 'config.json', 'config.py', 'config.yaml']
    found = False
    for file in config_files:
        if os.path.exists(file):
            print(f"âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: {file}")
            found = True
    if not found:
        print("âŒ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶")
    return found

def test_telegram():
    """æ¸¬è©¦Telegramç’°å¢ƒè®Šæ•¸"""
    token = os.environ.get('TG_TOKEN', '')
    chat_id = os.environ.get('TG_CHAT_ID', '')
    
    if token and chat_id:
        print(f"âœ… Telegram é…ç½®å­˜åœ¨ (Chat ID: {chat_id[:4]}***)")
        return True
    else:
        print("âš ï¸  Telegram ç’°å¢ƒè®Šæ•¸æœªè¨­ç½®")
        return False

if __name__ == "__main__":
    print("ğŸš€ é‹è¡Œå¿«é€Ÿæ¸¬è©¦...")
    results = []
    
    results.append(test_dependencies())
    results.append(test_config())
    results.append(test_telegram())
    
    print(f"\nğŸ“Š æ¸¬è©¦çµæœ: {sum(results)}/{len(results)} é€šé")
    
    if all(results):
        print("ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šé")
        sys.exit(0)
    else:
        print("âŒ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—")
        sys.exit(1)
EOF
            TEST_FILE="quick_test.py"
          else
            TEST_FILE="test_all.py"
          fi
          
          # é‹è¡Œæ¸¬è©¦ä¸¦æ•ç²è©³ç´°è¼¸å‡º
          echo "ğŸš€ åŸ·è¡Œæ¸¬è©¦æ–‡ä»¶: $TEST_FILE"
          set +e
          python $TEST_FILE 2>&1 | tee test_output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # åˆ†æçµæœ
          echo ""
          echo "ğŸ“Š æ¸¬è©¦çµæœåˆ†æ"
          echo "=============="
          
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "âœ… æ‰€æœ‰æ¸¬è©¦é€šé"
            echo "result=success" >> $GITHUB_OUTPUT
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ¸¬è©¦å¤±æ•—ï¼Œé€€å‡ºç¢¼: $TEST_EXIT_CODE"
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "status=failed" >> $GITHUB_OUTPUT
            
            # é¡¯ç¤ºéŒ¯èª¤æ‘˜è¦
            echo ""
            echo "ğŸ” éŒ¯èª¤æ‘˜è¦:"
            grep -i "error\|fail\|âŒ\|exception\|traceback" test_output.log | head -20 || true
          fi
      
      - name: ğŸ“Š ç”Ÿæˆè©³ç´°å ±å‘Š
        if: always()
        run: |
          echo "ğŸ“‹ è©³ç´°æ¸¬è©¦å ±å‘Š"
          echo "=============="
          echo "æ¸¬è©¦æ™‚é–“: $(date)"
          echo "ç³»çµ±: $RUNNER_OS"
          echo "Python: $(python --version)"
          echo "æ¸¬è©¦çµæœ: ${{ steps.run-tests.outputs.result || 'unknown' }}"
          echo "é€€å‡ºç¢¼: ${{ steps.run-tests.outputs.status || 'unknown' }}"
          
          if [ -f "test_output.log" ]; then
            echo ""
            echo "ğŸ“„ æœ€å¾Œ20è¡Œæ—¥èªŒ:"
            tail -20 test_output.log
          fi
      
      - name: ğŸ’¾ ä¿å­˜è¨ºæ–·è³‡æ–™
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: system-diagnostics-${{ github.run_id }}
          path: |
            test_output.log
            requirements.txt
            *.py
            .env
            config.*
          retention-days: 3

  run-monitor:
    name: ğŸš€ åŸ·è¡Œç›£æ§
    needs: test-system
    if: needs.test-system.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: ğŸ è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ”§ é æª¢é©—è­‰
        run: |
          echo "ğŸ”§ ç›£æ§ç³»çµ±é æª¢é©—è­‰"
          echo "=================="
          
          # é©—è­‰é—œéµæ–‡ä»¶
          REQUIRED_FILES=("dusk_monitor.py" "requirements.txt")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file å­˜åœ¨"
            else
              echo "âŒ $file ç¼ºå¤±"
              exit 1
            fi
          done
          
          # é©—è­‰ç’°å¢ƒè®Šæ•¸
          echo ""
          echo "ğŸ”‘ ç’°å¢ƒè®Šæ•¸é©—è­‰:"
          if [ -n "$TG_TOKEN" ] && [ -n "$TG_CHAT_ID" ]; then
            echo "âœ… Telegram é…ç½®å·²è¨­ç½®"
          else
            echo "âš ï¸  Telegram é…ç½®ä¸å®Œæ•´"
            echo "TG_TOKEN: $([ -n "$TG_TOKEN" ] && echo "å·²è¨­ç½®" || echo "æœªè¨­ç½®")"
            echo "TG_CHAT_ID: $([ -n "$TG_CHAT_ID" ] && echo "å·²è¨­ç½®" || echo "æœªè¨­ç½®")"
          fi
          
          echo ""
          echo "ğŸ“¦ Pythonæ¨¡çµ„æª¢æŸ¥:"
          python -c "
          import sys
          modules = ['requests', 'pandas', 'numpy', 'telegram', 'ccxt', 'datetime']
          for module in modules:
              try:
                  __import__(module)
                  print(f'âœ… {module}')
              except ImportError:
                  print(f'âŒ {module}')
          "
      
      - name: ğŸš€ å•Ÿå‹•ç›£æ§
        id: monitor
        env:
          TEST_MODE: ${{ inputs.test_mode || 'false' }}
        run: |
          echo "ğŸš€ å•Ÿå‹• DUSK/USDT ç›£æ§ç³»çµ±"
          echo "========================"
          
          # æº–å‚™åƒæ•¸
          ARGS=""
          if [ "$TEST_MODE" = "true" ]; then
            ARGS="--test --verbose"
            echo "ğŸ§ª æ¸¬è©¦æ¨¡å¼å•Ÿç”¨"
          fi
          
          # é‹è¡Œç›£æ§ï¼ˆæœ‰é™æ™‚é–“ï¼‰
          echo "â±ï¸  ç›£æ§é‹è¡Œæ™‚é–“: 300ç§’ (5åˆ†é˜)"
          echo "ğŸ“¡ é–‹å§‹åŸ·è¡Œ..."
          
          # å•Ÿå‹•ä¸¦è¨˜éŒ„
          START_TIME=$(date +%s)
          timeout 300 python dusk_monitor.py $ARGS 2>&1 | tee monitor.log
          EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          
          # çµæœåˆ†æ
          echo ""
          echo "ğŸ“Š ç›£æ§åŸ·è¡Œå ±å‘Š"
          echo "=============="
          echo "é‹è¡Œæ™‚é–“: $((END_TIME - START_TIME)) ç§’"
          echo "é€€å‡ºç¢¼: $EXIT_CODE"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… ç›£æ§æ­£å¸¸å®Œæˆ"
            echo "result=success" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 124 ]; then
            echo "â±ï¸  ç›£æ§è¶…æ™‚ï¼ˆæ­£å¸¸çµæŸï¼‰"
            echo "result=timeout" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç›£æ§ç•°å¸¸çµæŸ"
            echo "result=failure" >> $GITHUB_OUTPUT
          fi
          
          # é¡¯ç¤ºé—œéµæ—¥èªŒ
          echo ""
          echo "ğŸ“„ é—œéµæ—¥èªŒæ‘˜è¦:"
          grep -i "error\|warning\|alert\|difference\|å¥—åˆ©" monitor.log | tail -10 || echo "ç„¡é—œéµæ—¥èªŒ"
      
      - name: ğŸ’¾ ä¿å­˜ç›£æ§æ—¥èªŒ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs-${{ github.run_id }}
          path: |
            monitor.log
            *.log
            *.json
          retention-days: 3
      
      - name: ğŸ“§ ç°¡è¦é€šçŸ¥
        if: always()
        env:
          REPORT_TOKEN: ${{ secrets.REPORT_TOKEN || secrets.TG_TOKEN }}
          REPORT_CHAT_ID: ${{ secrets.REPORT_CHAT_ID || secrets.TG_CHAT_ID }}
        run: |
          echo "ğŸ“§ æº–å‚™åŸ·è¡Œå ±å‘Š..."
          
          SUMMARY="ğŸš€ DUSK/USDT ç›£æ§åŸ·è¡Œå®Œæˆ\n\n"
          SUMMARY+="â° æ™‚é–“: $(TZ='Asia/Taipei' date '+%m/%d %H:%M')\n"
          SUMMARY+="ğŸ“Š çµæœ: ${{ steps.monitor.outputs.result || 'unknown' }}\n"
          SUMMARY+="ğŸ”— æŸ¥çœ‹: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          
          echo "$SUMMARY"
          
          if [ -n "$REPORT_TOKEN" ] && [ -n "$REPORT_CHAT_ID" ] && [ "$TEST_MODE" != "true" ]; then
            echo "ğŸ“¤ ç™¼é€Telegramé€šçŸ¥..."
            curl -s -X POST "https://api.telegram.org/bot$REPORT_TOKEN/sendMessage" \
              -d chat_id="$REPORT_CHAT_ID" \
              -d text="$SUMMARY" \
              -d parse_mode="Markdown" \
              --max-time 5 > /dev/null 2>&1 || echo "âš ï¸  é€šçŸ¥ç™¼é€å¤±æ•—"
          fi

  cleanup:
    name: ğŸ§¹ æ¸…ç†èˆ‡åŒ¯ç¸½
    needs: [test-system, run-monitor]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ æœ€çµ‚å ±å‘Š
        run: |
          echo "ğŸ“‹ DUSK/USDT ç›£æ§å·¥ä½œæµå®Œæˆ"
          echo "=========================="
          echo "å·¥ä½œæµ: $GITHUB_WORKFLOW"
          echo "é‹è¡ŒID: $GITHUB_RUN_ID"
          echo "è§¸ç™¼: $GITHUB_ACTOR via $GITHUB_EVENT_NAME"
          echo ""
          echo "ğŸ“Š éšæ®µçµæœ:"
          echo "- æ¸¬è©¦: ${{ needs.test-system.result }}"
          echo "- ç›£æ§: ${{ needs.run-monitor.result }}"
          echo ""
          echo "â° å®Œæˆæ™‚é–“: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          
          # ç¸½é«”è©•ä¼°
          if [ "${{ needs.test-system.result }}" = "success" ] && [ "${{ needs.run-monitor.result }}" = "success" ]; then
            echo "ğŸ‰ ç‹€æ…‹: å®Œå…¨æˆåŠŸ"
          elif [ "${{ needs.test-system.result }}" = "failure" ]; then
            echo "âŒ ç‹€æ…‹: æ¸¬è©¦å¤±æ•—"
          else
            echo "âš ï¸  ç‹€æ…‹: éƒ¨åˆ†æˆåŠŸ"
          fi
      
      - name: ğŸ—‘ï¸ æ¸…ç†èˆŠæ—¥èªŒ
        if: success()
        run: |
          echo "ğŸ§¹ æ¸…ç†æš«å­˜æ–‡ä»¶..."
          # æ­¤è™•å¯æ·»åŠ æ¸…ç†æŒ‡ä»¤
          echo "âœ… æ¸…ç†å®Œæˆ"
