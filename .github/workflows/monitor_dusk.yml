name: DUSKUSDT 1-Minute Monitor

on:
  # å®šæ—¶è§¦å‘å™¨ - æ¯1åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '*/1 * * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean

# ========== å¹¶å‘æ§åˆ¶ ==========
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
# =============================

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆé˜²æ­¢ä»»åŠ¡å¡æ­»ï¼‰
    timeout-minutes: 3
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # æ­¥éª¤2: æ˜¾ç¤ºæ–‡ä»¶ç»“æ„ï¼ˆç”¨äºéªŒè¯ï¼‰
      - name: Verify file structure
        run: |
          echo "=== å½“å‰ç›®å½• ==="
          pwd
          echo ""
          echo "=== éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ ==="
          ls -la dusk_monitor.py && echo "âœ… dusk_monitor.py å­˜åœ¨" || echo "âŒ dusk_monitor.py ä¸å­˜åœ¨"
          ls -la requirements.txt && echo "âœ… requirements.txt å­˜åœ¨" || echo "âš ï¸ requirements.txt ä¸å­˜åœ¨"
          ls -la config.py && echo "âœ… config.py å­˜åœ¨" || echo "âš ï¸ config.py ä¸å­˜åœ¨"
          ls -la binance_client.py && echo "âœ… binance_client.py å­˜åœ¨" || echo "âš ï¸ binance_client.py ä¸å­˜åœ¨"
          echo ""
          echo "=== æ‰€æœ‰Pythonæ–‡ä»¶ ==="
          ls *.py
      
      # æ­¥éª¤3: è®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # æ­¥éª¤4: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          # å®‰è£…requirements.txtä¸­çš„ä¾èµ–
          if [ -f requirements.txt ]; then
            echo "å®‰è£… requirements.txt ä¸­çš„ä¾èµ–..."
            pip install -r requirements.txt
          else
            echo "æœªæ‰¾åˆ° requirements.txt"
          fi
          
          # å®‰è£…é¡¹ç›®å¯èƒ½éœ€è¦çš„å…¶ä»–ä¾èµ–
          echo "å®‰è£…å¸¸ç”¨åº“..."
          pip install requests python-dotenv schedule pandas
          
          # éªŒè¯å®‰è£…
          pip list | grep -E "requests|python-dotenv|schedule|pandas"
      
      # æ­¥éª¤5: è¿è¡Œç›‘æ§è„šæœ¬
      - name: Run DUSKUSDT Monitor
        env:
          DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
          # å¦‚æœè„šæœ¬éœ€è¦ç¯å¢ƒå˜é‡ï¼Œåœ¨è¿™é‡Œæ·»åŠ 
          # BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          # BINANCE_API_SECRET: ${{ secrets.BINANCE_API_SECRET }}
          # TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          # TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ğŸš€ å¯åŠ¨ DUSKUSDT 1åˆ†é’Ÿç›‘æ§..."
          echo "ğŸ“… æ—¶é—´: $(date)"
          echo "ğŸ› è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
          echo "ğŸ“ å·¥ä½œç›®å½•: $(pwd)"
          echo ""
          
          # éªŒè¯è„šæœ¬æ–‡ä»¶å­˜åœ¨
          if [ ! -f "dusk_monitor.py" ]; then
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° dusk_monitor.py æ–‡ä»¶"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°è„šæœ¬æ–‡ä»¶: dusk_monitor.py"
          echo "ğŸ“œ è„šæœ¬å¤§å°: $(wc -l < dusk_monitor.py) è¡Œ"
          echo ""
          
          # è¿è¡Œç›‘æ§è„šæœ¬
          echo "â–¶ï¸ å¼€å§‹æ‰§è¡Œç›‘æ§è„šæœ¬..."
          python dusk_monitor.py
          
          echo ""
          echo "âœ… è„šæœ¬æ‰§è¡Œå®Œæˆ"
          echo "â° ç»“æŸæ—¶é—´: $(date)"
      
      # æ­¥éª¤6: é”™è¯¯å¤„ç†
      - name: Handle Failure
        if: failure()
        run: |
          echo "âŒ ç›‘æ§ä»»åŠ¡å¤±è´¥!"
          echo ""
          echo "å¯èƒ½çš„åŸå› :"
          echo "1. Pythonè„šæœ¬è¯­æ³•é”™è¯¯"
          echo "2. ç¼ºå°‘ä¾èµ–åº“"
          echo "3. APIè¿æ¥é—®é¢˜"
          echo "4. ç¯å¢ƒå˜é‡æœªè®¾ç½®"
          echo ""
          echo "è¯·æ£€æŸ¥ 'Run DUSKUSDT Monitor' æ­¥éª¤çš„è¯¦ç»†è¾“å‡º"
          echo "å¦‚æœéœ€è¦è°ƒè¯•ï¼Œå¯ä»¥æ‰‹åŠ¨è§¦å‘å¹¶å¼€å¯ debug_mode"
