name: DUSKUSDT Minute Monitor

on:
  # å®šæ—¶è§¦å‘ - æ¯åˆ†é’Ÿä¸€æ¬¡
  schedule:
    - cron: '*/1 * * * *'
  
  # æ‰‹åŠ¨è§¦å‘ - æä¾›ä¸¤ç§æ¨¡å¼é€‰æ‹©
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'è¿è¡Œæ¨¡å¼é€‰æ‹©'
        required: true
        default: 'single'
        type: choice
        options:
          - single
          - continuous
      debug_mode:
        description: 'å¼€å¯è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

# å¹¶å‘æŽ§åˆ¶ï¼šä½¿ç”¨å·¥ä½œæµåç§°å’Œåˆ†æ”¯ä½œä¸ºç»„ï¼Œé˜²æ­¢åŒä¸€åˆ†æ”¯åŒæ—¶è¿è¡Œå¤šä¸ªå®žä¾‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 2  # å•æ¬¡æ£€æŸ¥åº”åœ¨2åˆ†é’Ÿå†…å®Œæˆ
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # æ­¥éª¤2: è®¾ç½®PythonçŽ¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # æ­¥éª¤3: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          # å®‰è£…åŸºç¡€ä¾èµ–
          pip install requests python-dotenv pandas ccxt python-telegram-bot schedule
          
          # å®‰è£…é¡¹ç›®ç‰¹å®šä¾èµ–
          if [ -f requirements.txt ]; then
            echo "å®‰è£… requirements.txt ä¸­çš„ä¾èµ–..."
            pip install -r requirements.txt
          else
            echo "æœªæ‰¾åˆ° requirements.txt"
          fi
      
      # æ­¥éª¤4: è¿è¡ŒDUSKUSDTç›‘æŽ§
      - name: Run DUSKUSDT Monitor
        env:
          # è„šæœ¬æ‰€éœ€çŽ¯å¢ƒå˜é‡
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TRADE_SYMBOL: ${{ secrets.TRADE_SYM }}
          
          # è¿è¡Œæ¨¡å¼æŽ§åˆ¶
          RUN_MODE: ${{ github.event_name == 'schedule' && 'single' || inputs.run_mode }}
          DEBUG_MODE: ${{ github.event_name == 'schedule' && 'false' || inputs.debug_mode }}
          PYTHONUNBUFFERED: '1'
        run: |
          echo "=== DUSKUSDT åŠ å¯†è´§å¸ç›‘æŽ§ç³»ç»Ÿ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è¿è¡Œæ¨¡å¼: $RUN_MODE"
          echo "è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
          echo "äº¤æ˜“å¯¹: $TRADE_SYMBOL"
          echo ""
          
          # æ ¹æ®è¿è¡Œæ¨¡å¼ç¡®å®šå¾ªçŽ¯æ¬¡æ•°
          if [ "$RUN_MODE" = "continuous" ]; then
            echo "âš ï¸ æ³¨æ„: æŒç»­æ¨¡å¼å°†åœ¨1åˆ†é’ŸåŽè‡ªåŠ¨ç»“æŸï¼Œé¿å…GitHub Actionsè¶…æ—¶"
            echo "å°†æ‰§è¡Œå•æ¬¡æ£€æŸ¥åŽé€€å‡ºï¼ˆé¿å…è¶…æ—¶ï¼‰"
            MAX_CYCLES=1
          else
            MAX_CYCLES=1
          fi
          
          # åˆ›å»ºPythonåŒ…è£…å™¨è„šæœ¬
          cat > run_dusk_monitor.py << 'EOF'
import os
import time
import subprocess
import sys

def run_single_check():
    """æ‰§è¡Œå•æ¬¡ç›‘æŽ§æ£€æŸ¥"""
    print(f"æ‰§è¡Œæ—¶é—´: {time.strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 50)
    
    # è¿è¡ŒåŽŸå§‹ç›‘æŽ§è„šæœ¬
    result = subprocess.run(
        [sys.executable, "dusk_monitor.py"],
        capture_output=True,
        text=True,
        encoding='utf-8'
    )
    
    # è¾“å‡ºç»“æžœ
    if result.stdout:
        print(result.stdout)
    
    if result.stderr:
        print("é”™è¯¯ä¿¡æ¯:", result.stderr)
    
    print("=" * 50)
    return result.returncode

def main():
    """ä¸»å‡½æ•°"""
    try:
        # æ‰§è¡Œç›‘æŽ§æ£€æŸ¥
        exit_code = run_single_check()
        
        if exit_code == 0:
            print("âœ… ç›‘æŽ§æ£€æŸ¥å®Œæˆ")
        else:
            print(f"âŒ ç›‘æŽ§æ£€æŸ¥å¤±è´¥ï¼Œé€€å‡ºç : {exit_code}")
        
        return exit_code
        
    except KeyboardInterrupt:
        print("\nç›‘æŽ§è¢«ç”¨æˆ·ä¸­æ–­")
        return 130
    except Exception as e:
        print(f"\nç›‘æŽ§å‘ç”Ÿé”™è¯¯: {str(e)}")
        return 1

if __name__ == "__main__":
    sys.exit(main())
EOF
          
          echo "æ‰§è¡Œç›‘æŽ§è„šæœ¬..."
          python run_dusk_monitor.py
          
          EXIT_CODE=$?
          
          echo ""
          echo "=== æ‰§è¡Œç»“æžœ ==="
          echo "é€€å‡ºä»£ç : $EXIT_CODE"
          echo "ç»“æŸæ—¶é—´: $(date)"
          
          # æ ¹æ®é€€å‡ºä»£ç å†³å®šæ˜¯å¦å¤±è´¥
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ ç›‘æŽ§æ‰§è¡Œå¤±è´¥"
            exit $EXIT_CODE
          else
            echo "âœ… ç›‘æŽ§æ‰§è¡ŒæˆåŠŸ"
          fi
      
      # æ­¥éª¤5: é”™è¯¯å¤„ç†
      - name: Handle Failure
        if: failure()
        run: |
          echo "âŒ ç›‘æŽ§ä»»åŠ¡å¤±è´¥"
          echo ""
          echo "å¸¸è§é—®é¢˜æŽ’æŸ¥:"
          echo "1. æ£€æŸ¥ dusk_monitor.py è„šæœ¬æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯"
          echo "2. ç¡®è®¤æ‰€æœ‰å¿…è¦çš„Pythonåº“éƒ½å·²å®‰è£…"
          echo "3. æ£€æŸ¥çŽ¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®"
          echo "4. æŸ¥çœ‹ä¸Šæ–¹è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo ""
          echo "ðŸ’¡ è°ƒè¯•å»ºè®®:"
          echo "- æ‰‹åŠ¨è¿è¡Œ: python dusk_monitor.py"
          echo "- æ£€æŸ¥ requirements.txt æ–‡ä»¶"
          echo "- ç¡®è®¤GitHub Secretsä¸­çš„å€¼æ­£ç¡®æ— è¯¯"
      
      # æ­¥éª¤6: æˆåŠŸé€šçŸ¥
      - name: Success Notification
        if: success()
        run: |
          echo "âœ… ç›‘æŽ§ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
          echo "ðŸ”„ ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œ: 1åˆ†é’ŸåŽ"
          echo "ðŸ“Š è¿è¡ŒåŽ†å²å¯åœ¨GitHub Actionsé¡µé¢æŸ¥çœ‹"
