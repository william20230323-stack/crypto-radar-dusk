name: DUSKUSDT 1-Minute Monitor

on:
  # å®šæ—¶è§¦å‘å™¨ - æ¯1åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '*/1 * * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean

# ========== å¹¶å‘æ§åˆ¶ ==========
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
# =============================

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆé˜²æ­¢ä»»åŠ¡å¡æ­»ï¼‰
    timeout-minutes: 3
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # æ­¥éª¤2: è®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # æ­¥éª¤3: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          # å®‰è£…requirements.txtä¸­çš„ä¾èµ–
          if [ -f requirements.txt ]; then
            echo "å®‰è£… requirements.txt ä¸­çš„ä¾èµ–..."
            pip install -r requirements.txt
          else
            echo "æœªæ‰¾åˆ° requirements.txt"
          fi
          
          # å®‰è£…å¸¸ç”¨åº“
          echo "å®‰è£…å¸¸ç”¨åº“..."
          pip install requests python-dotenv schedule pandas
      
      # æ­¥éª¤4: è¿è¡Œç›‘æ§è„šæœ¬ï¼ˆå…³é”®æ­¥éª¤ï¼‰
      - name: Run DUSKUSDT Monitor
        env:
          DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
          
          # ============================================
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯¹åº”æ‚¨çš„GitHub Secretsï¼‰
          # ============================================
          # Telegramé…ç½®
          TELEGRAM_BOT_TOKEN: ${{ secrets.TG_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          
          # äº¤æ˜“å¯¹é…ç½®
          TRADE_SYMBOL: ${{ secrets.TRADE_SYM }}
          
          # å¦‚æœéœ€è¦Binance APIå¯†é’¥ï¼Œæ·»åŠ è¿™é‡Œ
          # BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          # BINANCE_API_SECRET: ${{ secrets.BINANCE_API_SECRET }}
          
          # å…¶ä»–å¯èƒ½éœ€è¦çš„ç¯å¢ƒå˜é‡
          PYTHONUNBUFFERED: '1'  # ç¡®ä¿å®æ—¶è¾“å‡ºæ—¥å¿—
        run: |
          echo "ğŸš€ å¯åŠ¨ DUSKUSDT 1åˆ†é’Ÿç›‘æ§..."
          echo "ğŸ“… æ—¶é—´: $(date)"
          echo "ğŸ› è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
          echo "ğŸ“ å·¥ä½œç›®å½•: $(pwd)"
          echo ""
          
          # éªŒè¯è„šæœ¬æ–‡ä»¶å­˜åœ¨
          if [ ! -f "dusk_monitor.py" ]; then
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° dusk_monitor.py æ–‡ä»¶"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°è„šæœ¬æ–‡ä»¶: dusk_monitor.py"
          echo ""
          
          # éªŒè¯ç¯å¢ƒå˜é‡è®¾ç½®ï¼ˆä¸æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯ï¼‰
          echo "ğŸ”§ ç¯å¢ƒå˜é‡æ£€æŸ¥:"
          if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
            echo "âœ… TELEGRAM_BOT_TOKEN: å·²è®¾ç½®"
          else
            echo "âš ï¸ TELEGRAM_BOT_TOKEN: æœªè®¾ç½®"
          fi
          
          if [ -n "$TELEGRAM_CHAT_ID" ]; then
            echo "âœ… TELEGRAM_CHAT_ID: å·²è®¾ç½®"
          else
            echo "âš ï¸ TELEGRAM_CHAT_ID: æœªè®¾ç½®"
          fi
          
          if [ -n "$TRADE_SYMBOL" ]; then
            echo "âœ… TRADE_SYMBOL: $TRADE_SYMBOL"
          else
            echo "âš ï¸ TRADE_SYMBOL: æœªè®¾ç½®"
          fi
          echo ""
          
          # æ˜¾ç¤ºPythonç‰ˆæœ¬
          echo "ğŸ Pythonç‰ˆæœ¬:"
          python --version
          echo ""
          
          # è¿è¡Œç›‘æ§è„šæœ¬
          echo "â–¶ï¸ å¼€å§‹æ‰§è¡Œç›‘æ§è„šæœ¬..."
          echo "----------------------------------------"
          
          # è¿è¡Œè„šæœ¬å¹¶æ•è·è¾“å‡º
          python dusk_monitor.py
          
          EXIT_CODE=$?
          echo "----------------------------------------"
          echo ""
          echo "ğŸ“Š è„šæœ¬é€€å‡ºä»£ç : $EXIT_CODE"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥"
          fi
          
          echo "â° ç»“æŸæ—¶é—´: $(date)"
      
      # æ­¥éª¤5: é”™è¯¯å¤„ç†
      - name: Handle Failure
        if: failure()
        run: |
          echo "âŒ ç›‘æ§ä»»åŠ¡å¤±è´¥!"
          echo ""
          echo "å¸¸è§é—®é¢˜æ’æŸ¥:"
          echo "1. æ£€æŸ¥ dusk_monitor.py æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯"
          echo "2. ç¡®è®¤æ‰€æœ‰å¿…è¦çš„Pythonåº“éƒ½å·²å®‰è£…"
          echo "3. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®"
          echo "4. æŸ¥çœ‹è„šæœ¬æ˜¯å¦éœ€è¦Binance APIå¯†é’¥"
          echo ""
          echo "ğŸ’¡ å»ºè®®:"
          echo "- æ‰‹åŠ¨è¿è¡Œ python dusk_monitor.py æµ‹è¯•æœ¬åœ°ç¯å¢ƒ"
          echo "- æ£€æŸ¥ requirements.txt æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…è¦ä¾èµ–"
          echo "- ç¡®è®¤GitHub Secretsä¸­çš„å€¼æ­£ç¡®æ— è¯¯"
