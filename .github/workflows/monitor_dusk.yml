name: DUSKUSDT Minute Monitor

on:
  # ä½¿ç”¨pushè§¦å‘ä½œä¸ºæµ‹è¯•ï¼Œscheduleä½œä¸ºæ­£å¼è¿è¡Œ
  push:
    branches: [ main ]
    paths:
      - 'dusk_monitor.py'
      - '.github/workflows/monitor_dusk.yml'
  
  schedule:
    # æ¯åˆ†é’Ÿè§¦å‘ï¼Œä½†è„šæœ¬åªæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
    - cron: '*/1 * * * *'
  
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'single'
        type: choice
        options:
          - single
          - continuous
      debug_mode:
        description: 'è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # ä¸å–æ¶ˆæ—§ä»»åŠ¡ï¼Œé¿å…ç›‘æ§ä¸­æ–­

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 2  # å•æ¬¡æ£€æŸ¥åº”è¯¥åœ¨2åˆ†é’Ÿå†…å®Œæˆ
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # å®‰è£…åŸºç¡€ä¾èµ–
          pip install requests python-dotenv pandas ccxt python-telegram-bot
          # å®‰è£…é¡¹ç›®ä¾èµ–
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Configure monitoring mode
        id: config
        run: |
          # æ ¹æ®è¾“å…¥å‚æ•°ç¡®å®šè¿è¡Œæ¨¡å¼
          RUN_MODE="${{ inputs.run_mode }}"
          DEBUG_MODE="${{ inputs.debug_mode }}"
          
          if [ "$RUN_MODE" = "continuous" ]; then
            echo "è¿è¡Œæ¨¡å¼: æŒç»­ç›‘æ§ (é€‚åˆæ‰‹åŠ¨æµ‹è¯•)"
            echo "max_cycles=10" >> $GITHUB_OUTPUT
            echo "mode=continuous" >> $GITHUB_OUTPUT
          else
            echo "è¿è¡Œæ¨¡å¼: å•æ¬¡æ£€æŸ¥ (é€‚åˆå®šæ—¶ä»»åŠ¡)"
            echo "max_cycles=1" >> $GITHUB_OUTPUT
            echo "mode=single" >> $GITHUB_OUTPUT
          fi
          
          echo "è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
      
      - name: Run DUSKUSDT Monitor
        env:
          # è„šæœ¬ç¯å¢ƒå˜é‡
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TRADE_SYMBOL: ${{ secrets.TRADE_SYM }}
          
          # è¿è¡Œæ¨¡å¼æ§åˆ¶
          MAX_CYCLES: ${{ steps.config.outputs.max_cycles }}
          RUN_MODE: ${{ steps.config.outputs.mode }}
          DEBUG_MODE: ${{ inputs.debug_mode }}
          PYTHONUNBUFFERED: '1'
          
          # å·¥ä½œæµä¿¡æ¯
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: |
          echo "=== DUSKUSDT åŠ å¯†è´§å¸ç›‘æ§ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "è¿è¡Œæ¨¡å¼: $RUN_MODE"
          echo "æœ€å¤§å¾ªç¯æ¬¡æ•°: $MAX_CYCLES"
          echo "è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
          echo "äº¤æ˜“å¯¹: $TRADE_SYMBOL"
          echo "å·¥ä½œæµID: $GITHUB_RUN_ID ($GITHUB_RUN_NUMBER)"
          echo ""
          
          # åˆ›å»ºç›‘æ§è„šæœ¬çš„åŒ…è£…å™¨
          cat > run_monitor.py << 'EOF'
import os
import subprocess
import time
import sys

def run_monitor_cycle(cycle_num):
    """è¿è¡Œä¸€æ¬¡ç›‘æ§å¾ªç¯"""
    print(f"\n=== ç›‘æ§å¾ªç¯ #{cycle_num} ===")
    print(f"æ—¶é—´: {time.strftime('%Y-%m-%d %H:%M:%S')}")
    
    # è¿è¡ŒåŸå§‹ç›‘æ§è„šæœ¬
    result = subprocess.run([sys.executable, "dusk_monitor.py"], 
                          capture_output=True, text=True)
    
    # è¾“å‡ºç»“æœ
    if result.stdout:
        print("è„šæœ¬è¾“å‡º:")
        print(result.stdout)
    
    if result.stderr:
        print("é”™è¯¯è¾“å‡º:")
        print(result.stderr)
    
    return result.returncode

def main():
    max_cycles = int(os.getenv('MAX_CYCLES', 1))
    run_mode = os.getenv('RUN_MODE', 'single')
    
    print(f"é…ç½®: æ¨¡å¼={run_mode}, æœ€å¤§å¾ªç¯={max_cycles}")
    
    cycles_completed = 0
    
    try:
        for i in range(1, max_cycles + 1):
            exit_code = run_monitor_cycle(i)
            cycles_completed = i
            
            # å¦‚æœæ˜¯å•æ¬¡æ¨¡å¼ï¼Œè¿è¡Œä¸€æ¬¡å°±é€€å‡º
            if run_mode == 'single':
                break
            
            # å¦‚æœæ˜¯æŒç»­æ¨¡å¼ï¼Œç­‰å¾…ä¸‹ä¸€åˆ†é’Ÿ
            if i < max_cycles:
                print(f"\nç­‰å¾…ä¸‹ä¸€åˆ†é’Ÿ... ({i}/{max_cycles})")
                # è®¡ç®—åˆ°ä¸‹ä¸€åˆ†é’Ÿ00ç§’çš„ç­‰å¾…æ—¶é—´
                current_seconds = int(time.time()) % 60
                wait_seconds = 60 - current_seconds
                if wait_seconds > 0:
                    print(f"ç­‰å¾… {wait_seconds} ç§’...")
                    time.sleep(wait_seconds)
    
    except KeyboardInterrupt:
        print("\nç›‘æ§è¢«ä¸­æ–­")
    except Exception as e:
        print(f"\nç›‘æ§å‘ç”Ÿé”™è¯¯: {e}")
    
    print(f"\n=== ç›‘æ§ç»“æŸ ===")
    print(f"å®Œæˆå¾ªç¯: {cycles_completed}/{max_cycles}")
    print(f"ç»“æŸæ—¶é—´: {time.strftime('%Y-%m-%d %H:%M:%S')}")
    
    return 0

if __name__ == "__main__":
    sys.exit(main())
EOF
          
          # è¿è¡ŒåŒ…è£…å™¨è„šæœ¬
          echo "æ‰§è¡Œç›‘æ§è„šæœ¬..."
          python run_monitor.py
      
      - name: Upload logs (å¯é€‰)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs-${{ github.run_id }}
          path: |
            run_monitor.py
          retention-days: 7
      
      - name: Success Notification
        if: success()
        run: |
          echo "âœ… ç›‘æ§ä»»åŠ¡å®Œæˆ"
          echo "ğŸ“Š ä¸‹æ¬¡è¿è¡Œ: 1åˆ†é’Ÿå"
          echo "ğŸ”” å¦‚æœ‰è­¦æŠ¥å°†é€šè¿‡Telegramå‘é€"
      
      - name: Failure Notification
        if: failure()
        run: |
          echo "âŒ ç›‘æ§ä»»åŠ¡å¤±è´¥"
          echo ""
          echo "å¯èƒ½åŸå› :"
          echo "1. è„šæœ¬æ‰§è¡Œé”™è¯¯"
          echo "2. APIè¿æ¥é—®é¢˜"
          echo "3. ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯"
          echo ""
          echo "å»ºè®®æ£€æŸ¥:"
          echo "- æŸ¥çœ‹ä¸Šæ–¹è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "- ç¡®è®¤GitHub Secretsè®¾ç½®æ­£ç¡®"
          echo "- æµ‹è¯•è„šæœ¬æœ¬åœ°è¿è¡Œ"
