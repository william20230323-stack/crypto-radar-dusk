name: DUSKUSDT Minute Monitor

on:
  # å®šæ—¶è§¦å‘ - æ¯åˆ†é’Ÿä¸€æ¬¡
  schedule:
    - cron: '*/1 * * * *'
  
  # æ‰‹åŠ¨è§¦å‘ - æä¾›æ¸…æ™°çš„å¯åŠ¨é€‰é¡¹
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'single'
        type: choice
        options:
          - single
          - continuous
      debug_mode:
        description: 'è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

# å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv pandas ccxt python-telegram-bot schedule
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: è¿è¡ŒDUSKUSDTç›‘æ§
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TRADE_SYMBOL: ${{ secrets.TRADE_SYM }}
          RUN_MODE: ${{ github.event_name == 'schedule' && 'single' || inputs.run_mode }}
          DEBUG_MODE: ${{ github.event_name == 'schedule' && 'false' || inputs.debug_mode }}
          PYTHONUNBUFFERED: '1'
        run: |
          echo "=== DUSKUSDTåŠ å¯†è´§å¸ç›‘æ§ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è¿è¡Œæ¨¡å¼: $RUN_MODE"
          echo "è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
          echo "äº¤æ˜“å¯¹: $TRADE_SYMBOL"
          echo ""
          
          # éªŒè¯ç¯å¢ƒå˜é‡
          if [ -z "$TG_TOKEN" ]; then
            echo "âŒ é”™è¯¯: TG_TOKEN æœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "$TG_CHAT_ID" ]; then
            echo "âŒ é”™è¯¯: TG_CHAT_ID æœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "$TRADE_SYMBOL" ]; then
            echo "âŒ é”™è¯¯: TRADE_SYMBOL æœªè®¾ç½®"
            exit 1
          fi
          
          echo "âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡"
          
          # æ ¹æ®è¿è¡Œæ¨¡å¼æ‰§è¡Œ
          if [ "$RUN_MODE" = "continuous" ]; then
            echo "âš ï¸ æ³¨æ„: è¿ç»­æ¨¡å¼å°†è¿è¡Œ2ä¸ªå¾ªç¯ï¼ˆé¿å…è¶…æ—¶ï¼‰"
            for i in 1 2; do
              echo ""
              echo "--- å¾ªç¯ $i ---"
              python dusk_monitor.py
              
              # å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´
              if [ $i -lt 2 ]; then
                echo "ç­‰å¾…30ç§’..."
                sleep 30
              fi
            done
          else
            echo "æ‰§è¡Œå•æ¬¡ç›‘æ§..."
            python dusk_monitor.py
          fi
          
          echo ""
          echo "âœ… ç›‘æ§æ‰§è¡Œå®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"
      
      - name: é”™è¯¯å¤„ç†
        if: failure()
        run: |
          echo "âŒ ç›‘æ§ä»»åŠ¡å¤±è´¥"
          echo ""
          echo "å»ºè®®:"
          echo "1. æ£€æŸ¥ dusk_monitor.py è„šæœ¬æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯"
          echo "2. ç¡®è®¤æ‰€æœ‰å¿…è¦çš„Pythonåº“éƒ½å·²å®‰è£…"
          echo "3. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®"
          echo "4. å°è¯•æœ¬åœ°è¿è¡Œ: python dusk_monitor.py"
      
      - name: æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… ç›‘æ§ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
          echo "ğŸ”„ ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œ: 1åˆ†é’Ÿå"
          echo "ğŸ“Š è¿è¡ŒID: ${{ github.run_id }}"
