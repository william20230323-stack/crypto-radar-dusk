name: DUSKUSDT 1-Minute Monitor

on:
  # å®šæ—¶è§¦å‘ - æ¯åˆ†é’Ÿä¸€æ¬¡
  schedule:
    - cron: '*/1 * * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å¼€å¯è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

# å¹¶å‘æŽ§åˆ¶ - ç¡®ä¿æ¯åˆ†é’Ÿåªæœ‰ä¸€ä¸ªå®žä¾‹è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 1  # é™åˆ¶æ¯æ¬¡è¿è¡Œä¸è¶…è¿‡1åˆ†é’Ÿ
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv pandas ccxt python-telegram-bot schedule
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: è¿è¡ŒDUSKUSDTç›‘æŽ§
        env:
          # è„šæœ¬æ‰€éœ€çŽ¯å¢ƒå˜é‡
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TRADE_SYMBOL: ${{ secrets.TRADE_SYMBOL || secrets.TRADE_SYM || 'DUSKUSDT' }}
          
          # è°ƒè¯•æ¨¡å¼
          DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
          PYTHONUNBUFFERED: '1'
        run: |
          echo "=== DUSKUSDTåŠ å¯†è´§å¸ç›‘æŽ§ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
          echo "äº¤æ˜“å¯¹: $TRADE_SYMBOL"
          echo ""
          
          # éªŒè¯çŽ¯å¢ƒå˜é‡
          if [ -z "$TG_TOKEN" ]; then
            echo "âŒ é”™è¯¯: TG_TOKEN æœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "$TG_CHAT_ID" ]; then
            echo "âŒ é”™è¯¯: TG_CHAT_ID æœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "$TRADE_SYMBOL" ]; then
            echo "âŒ é”™è¯¯: TRADE_SYMBOL æœªè®¾ç½®"
            exit 1
          fi
          
          echo "âœ… çŽ¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡"
          echo ""
          
          # åˆ›å»ºå•æ¬¡æ‰§è¡Œç‰ˆæœ¬
          echo "åˆ›å»ºå•æ¬¡æ‰§è¡Œè„šæœ¬..."
          cat > run_single_check.py << 'EOF'
import os
import sys

# ä¿®æ”¹åŽŸå§‹è„šæœ¬çš„å¯¼å…¥
original_script = open("dusk_monitor.py", "r", encoding="utf-8").read()

# ä¿®æ”¹è„šæœ¬ï¼Œè®©å®ƒåªæ‰§è¡Œä¸€æ¬¡
modified_script = original_script.replace(
    "while True:",
    "# ä¿®æ”¹ä¸ºå•æ¬¡æ‰§è¡Œ\nif True:"
)

# æ·»åŠ å¼ºåˆ¶é€€å‡ºï¼Œé¿å…ç­‰å¾…
modified_script = modified_script.replace(
    "ç­‰å¾…åˆ°ä¸‹ä¸€å€‹åˆ†é˜çš„00ç§’...",
    "å•æ¬¡æ‰§è¡Œå®Œæˆï¼Œé€€å‡ºç¨‹åº..."
)

modified_script = modified_script.replace(
    "ç­‰å¾… 55 ç§’ç›´åˆ°ä¸‹ä¸€åˆ†é˜æ•´é»ž",
    "å•æ¬¡æ‰§è¡Œå®Œæˆï¼Œé€€å‡ºç¨‹åº"
)

# åœ¨è„šæœ¬æœ€åŽæ·»åŠ sys.exit(0)
if "sys.exit(0)" not in modified_script:
    modified_script += "\n\n# å•æ¬¡æ‰§è¡Œå®Œæˆ\nprint('âœ… å•æ¬¡æ£€æŸ¥å®Œæˆï¼Œé€€å‡ºç¨‹åº')\nsys.exit(0)"

exec(modified_script)
EOF
          
          echo "æ‰§è¡Œå•æ¬¡æ£€æŸ¥..."
          python run_single_check.py
          
          EXIT_CODE=$?
          echo ""
          echo "=== æ‰§è¡Œç»“æžœ ==="
          echo "è„šæœ¬é€€å‡ºä»£ç : $EXIT_CODE"
          echo "ç»“æŸæ—¶é—´: $(date)"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… ç›‘æŽ§æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ ç›‘æŽ§æ‰§è¡Œå¤±è´¥"
            exit $EXIT_CODE
          fi
      
      - name: é”™è¯¯å¤„ç†
        if: failure()
        run: |
          echo "âŒ ç›‘æŽ§ä»»åŠ¡å¤±è´¥"
          echo ""
          echo "å¸¸è§é—®é¢˜:"
          echo "1. æ£€æŸ¥ dusk_monitor.py è„šæœ¬æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯"
          echo "2. ç¡®è®¤æ‰€æœ‰å¿…è¦çš„Pythonåº“éƒ½å·²å®‰è£…"
          echo "3. æ£€æŸ¥çŽ¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®"
          echo "4. å°è¯•æœ¬åœ°è¿è¡Œ: python dusk_monitor.py"
          echo ""
          echo "ðŸ’¡ å»ºè®®:"
          echo "- ä¿®æ”¹è„šæœ¬ä¸ºå•æ¬¡æ‰§è¡Œæ¨¡å¼"
          echo "- æˆ–è€…ä½¿ç”¨æ›´ç®€å•çš„æ–¹æ¡ˆï¼šç›´æŽ¥è¿è¡Œè„šæœ¬å¹¶ç”¨timeouté™åˆ¶"
      
      - name: æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… ç›‘æŽ§ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
          echo "ðŸ”„ ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œ: 1åˆ†é’ŸåŽ"
          echo "ðŸ“Š è¿è¡ŒID: ${{ github.run_id }}"
