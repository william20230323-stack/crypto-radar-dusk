name: DUSK/USDT Multi-Exchange Monitor

on:
  schedule:
    - cron: '*/15 * * * *'
  
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æ¸¬è©¦æ¨¡å¼ï¼ˆä¸ç™¼é€çœŸå¯¦è­¦å ±ï¼‰'
        required: false
        default: 'false'
        type: boolean
  
  push:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - '.github/workflows/**'

env:
  TG_TOKEN: ${{ secrets.TG_TOKEN }}
  TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
  PYTHON_VERSION: '3.9'
  CHECK_INTERVAL: '15'

jobs:
  test-system:
    name: ğŸ” ç³»çµ±æ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v3
      
      - name: ğŸ è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: pip install -r requirements.txt
      
      - name: ğŸ§ª é‹è¡Œæ¸¬è©¦
        run: python test_all.py
      
      - name: ğŸ’¾ ä¿å­˜æ—¥èªŒ
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: *.log

  run-monitor:
    name: ğŸš€ åŸ·è¡Œç›£æ§
    needs: test-system
    if: needs.test-system.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v3
      
      - name: ğŸ è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: pip install -r requirements.txt
      
      - name: ğŸš€ å•Ÿå‹•ç›£æ§
        run: python dusk_monitor.py
      
      - name: ğŸ’¾ ä¿å­˜æ—¥èªŒ
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs
          path: *.log
