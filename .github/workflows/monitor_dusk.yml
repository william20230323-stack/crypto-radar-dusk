name: DUSK/USDT Multi-Exchange Monitor

on:
  # æ¯15åˆ†é˜é‹è¡Œä¸€æ¬¡ï¼ˆå¯æ ¹æ“šéœ€è¦èª¿æ•´ï¼‰
  schedule:
    - cron: '*/15 * * * *'
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æ¸¬è©¦æ¨¡å¼ï¼ˆä¸ç™¼é€çœŸå¯¦è­¦å ±ï¼‰'
        required: false
        default: 'false'
        type: boolean
  
  # ä»£ç¢¼æŽ¨é€æ™‚ä¹Ÿé‹è¡Œï¼ˆå¯é¸ï¼‰
  push:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - '.github/workflows/**'

env:
  # ç’°å¢ƒè®Šæ•¸ï¼ˆåœ¨GitHub Secretsä¸­è¨­ç½®ï¼‰
  TG_TOKEN: ${{ secrets.TG_TOKEN }}
  TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
  
  # ç³»çµ±é…ç½®
  PYTHON_VERSION: '3.9'
  CHECK_INTERVAL: '15'  # æŽƒæé–“éš”ï¼ˆç§’ï¼‰

jobs:
  # ç¬¬ä¸€æ­¥ï¼šé‹è¡Œç³»çµ±æ¸¬è©¦
  test-system:
    name: ðŸ” ç³»çµ±æ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v3
      
      - name: ðŸ è¨­ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ å®‰è£ä¾è³´
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… ä¾è³´å®‰è£å®Œæˆ"
      
      - name: ðŸ§ª é‹è¡Œå…¨é¢æ¸¬è©¦
        id: run-tests
        run: |
          echo "ðŸ§ª é–‹å§‹ç³»çµ±æ¸¬è©¦..."
          if python test_all.py; then
            echo "âœ… æ‰€æœ‰æ¸¬è©¦é€šéŽ"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ¸¬è©¦å¤±æ•—"
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ðŸ“Š ç”Ÿæˆæ¸¬è©¦å ±å‘Š
        if: always()
        run: |
          echo "ðŸ“‹ æ¸¬è©¦å ±å‘Š"
          echo "=========="
          echo "æ¸¬è©¦æ™‚é–“: $(date)"
          echo "Pythonç‰ˆæœ¬: $(python --version)"
          echo "ä½œæ¥­ç³»çµ±: $RUNNER_OS"
          echo "æ¸¬è©¦çµæžœ: ${{ steps.run-tests.outputs.result || 'unknown' }}"
      
      - name: ðŸ’¾ ä¿å­˜æ¸¬è©¦æ—¥èªŒ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-logs
          path: |
            *.log
            test_output*.txt
          retention-days: 7

  # ç¬¬äºŒæ­¥ï¼šåŸ·è¡Œç›£æŽ§ï¼ˆä¾è³´æ¸¬è©¦æˆåŠŸï¼‰
  run-monitor:
    name: ðŸš€ åŸ·è¡Œç›£æŽ§
    needs: test-system
    if: needs.test-system.result == 'success'
    runs-on: ubuntu-latest
    
    # è¶…æ™‚è¨­ç½®ï¼šç›£æŽ§é‹è¡Œ30åˆ†é˜
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v3
      
      - name: ðŸ è¨­ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ å®‰è£ä¾è³´
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ”§ ç’°å¢ƒæª¢æŸ¥
        run: |
          echo "ðŸ”§ ç’°å¢ƒæª¢æŸ¥"
          echo "=========="
          echo "TG_TOKENè¨­ç½®: ${{ env.TG_TOKEN != '' && 'âœ… å·²è¨­ç½®' || 'âŒ æœªè¨­ç½®' }}"
          echo "TG_CHAT_IDè¨­ç½®: ${{ env.TG_CHAT_ID != '' && 'âœ… å·²è¨­ç½®' || 'âŒ æœªè¨­ç½®' }}"
          echo "Pythonç‰ˆæœ¬: $(python --version)"
          echo "ç•¶å‰æ™‚é–“: $(date)"
          echo "å°ç£æ™‚é–“: $(TZ='Asia/Taipei' date)"
          
          if [ -z "$TG_TOKEN" ] || [ -z "$TG_CHAT_ID" ]; then
            echo "âŒ ç’°å¢ƒè®Šæ•¸æœªå®Œæ•´è¨­ç½®ï¼Œç›£æŽ§å¯èƒ½ç„¡æ³•ç™¼é€è­¦å ±"
          fi
      
      - name: ðŸš€ å•Ÿå‹•å¤šäº¤æ˜“æ‰€ç›£æŽ§
        id: monitor
        env:
          # å¦‚æžœæ˜¯æ¸¬è©¦æ¨¡å¼ï¼Œè¨­ç½®æ¨™è¨˜
          TEST_MODE: ${{ inputs.test_mode || 'false' }}
        run: |
          echo "ðŸš€ å•Ÿå‹• DUSK/USDT å¤šäº¤æ˜“æ‰€ç›£æŽ§ç³»çµ±"
          echo "=================================="
          
          # é¡¯ç¤ºå•Ÿå‹•ä¿¡æ¯
          echo "ðŸ¦ äº¤æ˜“æ‰€æ•¸é‡: 6 å®¶"
          echo "â° æŽƒæé–“éš”: ${{ env.CHECK_INTERVAL }} ç§’"
          echo "ðŸŒ æ™‚å€: å°ç£æ™‚é–“ (UTC+8)"
          echo "ðŸ§ª æ¸¬è©¦æ¨¡å¼: $TEST_MODE"
          echo ""
          
          # è¨­ç½®ç›£æŽ§åƒæ•¸
          MONITOR_ARGS=""
          if [ "$TEST_MODE" = "true" ]; then
            MONITOR_ARGS="--test-mode"
            echo "âš ï¸  æ¸¬è©¦æ¨¡å¼å•Ÿç”¨ï¼šä¸æœƒç™¼é€çœŸå¯¦è­¦å ±"
          fi
          
          # é‹è¡Œç›£æŽ§ï¼ˆ5åˆ†é˜ï¼Œç„¶å¾Œæ‰‹å‹•åœæ­¢ï¼‰
          echo "ðŸ”„ é–‹å§‹ç›£æŽ§é‹è¡Œï¼ˆ5åˆ†é˜æ¸¬è©¦ï¼‰..."
          
          # å•Ÿå‹•ç›£æŽ§é€²ç¨‹ï¼ˆå¾Œå°é‹è¡Œï¼‰
          python dusk_monitor.py $MONITOR_ARGS > monitor_output.log 2>&1 &
          MONITOR_PID=$!
          
          echo "ðŸ“Š ç›£æŽ§é€²ç¨‹å·²å•Ÿå‹• (PID: $MONITOR_PID)"
          
          # ç­‰å¾…5åˆ†é˜
          for i in {1..20}; do
            sleep 15
            echo "â³ ç›£æŽ§é‹è¡Œä¸­... ($((i*15)) ç§’)"
            
            # æª¢æŸ¥é€²ç¨‹æ˜¯å¦é‚„åœ¨é‹è¡Œ
            if ! kill -0 $MONITOR_PID 2>/dev/null; then
              echo "âš ï¸  ç›£æŽ§é€²ç¨‹æ„å¤–åœæ­¢"
              break
            fi
          done
          
          # åœæ­¢ç›£æŽ§
          echo "ðŸ›‘ åœæ­¢ç›£æŽ§é€²ç¨‹..."
          kill $MONITOR_PID 2>/dev/null || true
          
          # é¡¯ç¤ºæ—¥èªŒ
          echo ""
          echo "ðŸ“„ ç›£æŽ§æ—¥èªŒè¼¸å‡º:"
          echo "================"
          tail -50 monitor_output.log || echo "ç„¡æ—¥èªŒè¼¸å‡º"
          
          echo "âœ… ç›£æŽ§é‹è¡Œå®Œæˆ"
          
          # æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
          if grep -q "âŒ\|ERROR\|Error\|error" monitor_output.log; then
            echo "result=error" >> $GITHUB_OUTPUT
            echo "errors=true" >> $GITHUB_OUTPUT
          else
            echo "result=success" >> $GITHUB_OUTPUT
            echo "errors=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ’¾ ä¿å­˜ç›£æŽ§æ—¥èªŒ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: monitor-logs
          path: |
            monitor_output.log
            *.log
          retention-days: 7
      
      - name: ðŸ“§ ç™¼é€åŸ·è¡Œå ±å‘Š
        if: always()
        env:
          # ä½¿ç”¨ä¸åŒçš„Telegramé…ç½®ç™¼é€å ±å‘Šï¼ˆå¯é¸ï¼‰
          REPORT_TOKEN: ${{ secrets.REPORT_TOKEN || secrets.TG_TOKEN }}
          REPORT_CHAT_ID: ${{ secrets.REPORT_CHAT_ID || secrets.TG_CHAT_ID }}
        run: |
          echo "ðŸ“§ ç”ŸæˆåŸ·è¡Œå ±å‘Š..."
          
          # å‰µå»ºå ±å‘Šå…§å®¹
          REPORT="ðŸš€ DUSK/USDT ç›£æŽ§ç³»çµ±åŸ·è¡Œå ±å‘Š\n\n"
          REPORT+="â° åŸ·è¡Œæ™‚é–“: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')\n"
          REPORT+="ðŸ“Š åŸ·è¡Œçµæžœ: ${{ steps.monitor.outputs.result || 'unknown' }}\n"
          REPORT+="âŒ æ˜¯å¦æœ‰éŒ¯èª¤: ${{ steps.monitor.outputs.errors || 'unknown' }}\n"
          REPORT+="ðŸ¦ äº¤æ˜“æ‰€æ•¸é‡: 6 å®¶\n"
          REPORT+="ðŸ”— å·¥ä½œæµ: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID\n"
          
          # å¦‚æžœæœ‰éŒ¯èª¤ï¼Œæ·»åŠ è©³ç´°ä¿¡æ¯
          if [ "${{ steps.monitor.outputs.errors }}" = "true" ]; then
            REPORT+="\nâš ï¸  æª¢æ¸¬åˆ°éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ—¥èªŒã€‚\n"
          fi
          
          echo "$REPORT"
          
          # å¯é¸ï¼šç™¼é€åˆ°Telegram
          if [ -n "$REPORT_TOKEN" ] && [ -n "$REPORT_CHAT_ID" ]; then
            echo "ðŸ“¤ ç™¼é€å ±å‘Šåˆ°Telegram..."
            curl -s -X POST "https://api.telegram.org/bot$REPORT_TOKEN/sendMessage" \
              -d chat_id="$REPORT_CHAT_ID" \
              -d text="$REPORT" \
              -d parse_mode="Markdown" \
              --max-time 10 || echo "âš ï¸  å ±å‘Šç™¼é€å¤±æ•—"
          else
            echo "âš ï¸  æœªé…ç½®å ±å‘ŠTokenï¼Œè·³éŽç™¼é€"
          fi

  # ç¬¬ä¸‰æ­¥ï¼šæ¸…ç†å’Œé€šçŸ¥ï¼ˆå¯é¸ï¼‰
  cleanup:
    name: ðŸ§¹ æ¸…ç†
    needs: [test-system, run-monitor]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“‹ é¡¯ç¤ºæœ€çµ‚å ±å‘Š
        run: |
          echo "ðŸ“‹ DUSK/USDT ç›£æŽ§å·¥ä½œæµåŸ·è¡Œå®Œæˆ"
          echo "================================"
          echo "å·¥ä½œæµ: $GITHUB_WORKFLOW"
          echo "é‹è¡ŒID: $GITHUB_RUN_ID"
          echo "è§¸ç™¼è€…: $GITHUB_ACTOR"
          echo "è§¸ç™¼äº‹ä»¶: $GITHUB_EVENT_NAME"
          echo "æ¸¬è©¦çµæžœ: ${{ needs.test-system.result }}"
          echo "ç›£æŽ§çµæžœ: ${{ needs.run-monitor.result }}"
          echo "å®Œæˆæ™‚é–“: $(date)"
          echo "å°ç£æ™‚é–“: $(TZ='Asia/Taipei' date)"
      
      - name: ðŸ“Š å·¥ä½œæµç‹€æ…‹
        if: always()
        run: |
          # è¨ˆç®—ç¸½é«”ç‹€æ…‹
          TEST_STATUS="${{ needs.test-system.result }}"
          MONITOR_STATUS="${{ needs.run-monitor.result }}"
          
          if [ "$TEST_STATUS" = "success" ] && [ "$MONITOR_STATUS" = "success" ]; then
            echo "ðŸŽ‰ å·¥ä½œæµåŸ·è¡ŒæˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          elif [ "$TEST_STATUS" = "failure" ]; then
            echo "âŒ æ¸¬è©¦éšŽæ®µå¤±æ•—"
            echo "status=failure" >> $GITHUB_OUTPUT
          elif [ "$MONITOR_STATUS" = "failure" ] || [ "$MONITOR_STATUS" = "cancelled" ]; then
            echo "âš ï¸  ç›£æŽ§éšŽæ®µå¤±æ•—æˆ–è¢«å–æ¶ˆ"
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "â“ æœªçŸ¥ç‹€æ…‹"
            echo "status=unknown" >> $GITHUB_OUTPUT
          fi
