name: DUSKUSDT 1-Minute Monitor

on:
  # å®šæ—¶è§¦å‘ - æ¯åˆ†é’Ÿä¸€æ¬¡
  schedule:
    - cron: '*/1 * * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å¼€å¯è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

# å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv pandas ccxt python-telegram-bot schedule
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: è°ƒè¯• - æŸ¥çœ‹æ‰€æœ‰å¯ç”¨Secrets
        run: |
          echo "=== è°ƒè¯•ï¼šç¯å¢ƒå˜é‡è®¾ç½®æƒ…å†µ ==="
          echo "æ³¨ï¼šSecretå€¼ä¸ä¼šæ˜¾ç¤ºï¼Œåªæ˜¾ç¤ºåç§°"
          echo ""
          echo "1. å°è¯•è¯»å–å¯èƒ½çš„TRADE_SYMBOLç›¸å…³Secretï¼š"
          echo "   GitHub Secretåç§°å¯èƒ½æ˜¯ï¼šTRADE_SYM, TRADE_SYMBOL, æˆ–å…¶ä»–"
          echo ""
          echo "2. å½“å‰å·¥ä½œæµé…ç½®çš„ç¯å¢ƒå˜é‡ï¼š"
          echo "   TG_TOKEN: ${{ secrets.TG_TOKEN != '' && 'å·²è®¾ç½®' || 'æœªè®¾ç½®' }}"
          echo "   TG_CHAT_ID: ${{ secrets.TG_CHAT_ID != '' && 'å·²è®¾ç½®' || 'æœªè®¾ç½®' }}"
          echo "   TRADE_SYM: ${{ secrets.TRADE_SYM != '' && 'å·²è®¾ç½®' || 'æœªè®¾ç½®' }}"
          echo ""
          echo "3. å°è¯•ä¸åŒåç§°çš„Secretï¼š"
          echo "   TRADE_SYM å­˜åœ¨: ${{ secrets.TRADE_SYM != '' && 'æ˜¯' || 'å¦' }}"
          echo "   TRADE_SYMBOL å­˜åœ¨: ${{ secrets.TRADE_SYMBOL != '' && 'æ˜¯' || 'å¦' }}"
      
      - name: è¿è¡ŒDUSKUSDTç›‘æ§
        env:
          # Telegram é…ç½®
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          
          # äº¤æ˜“å¯¹é…ç½® - å°è¯•å¤šç§å¯èƒ½çš„Secretåç§°
          # ä½¿ç”¨é€»è¾‘ï¼šå¦‚æœTRADE_SYMBOLå­˜åœ¨å°±ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨TRADE_SYMï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼
          TRADE_SYMBOL: ${{ secrets.TRADE_SYMBOL || secrets.TRADE_SYM || 'DUSKUSDT' }}
          
          # è°ƒè¯•æ¨¡å¼
          DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
          PYTHONUNBUFFERED: '1'
        run: |
          echo "=== DUSKUSDTåŠ å¯†è´§å¸ç›‘æ§ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
          echo ""
          
          echo "=== ç¯å¢ƒå˜é‡æ£€æŸ¥ ==="
          # æ£€æŸ¥TG_TOKEN
          if [ -n "$TG_TOKEN" ]; then
            echo "âœ… TG_TOKEN: å·²è®¾ç½® (é•¿åº¦: ${#TG_TOKEN})"
          else
            echo "âŒ TG_TOKEN: æœªè®¾ç½®"
            exit 1
          fi
          
          # æ£€æŸ¥TG_CHAT_ID
          if [ -n "$TG_CHAT_ID" ]; then
            echo "âœ… TG_CHAT_ID: $TG_CHAT_ID"
          else
            echo "âŒ TG_CHAT_ID: æœªè®¾ç½®"
            exit 1
          fi
          
          # æ£€æŸ¥TRADE_SYMBOL
          if [ -n "$TRADE_SYMBOL" ]; then
            echo "âœ… TRADE_SYMBOL: $TRADE_SYMBOL"
          else
            echo "âŒ TRADE_SYMBOL: æœªè®¾ç½®"
            exit 1
          fi
          
          echo ""
          echo "=== è¿è¡Œç›‘æ§è„šæœ¬ ==="
          
          # éªŒè¯è„šæœ¬æ–‡ä»¶
          if [ ! -f "dusk_monitor.py" ]; then
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° dusk_monitor.py"
            echo "å½“å‰ç›®å½•æ–‡ä»¶:"
            ls -la
            exit 1
          fi
          
          # è¿è¡Œç›‘æ§è„šæœ¬
          python dusk_monitor.py
          
          EXIT_CODE=$?
          echo ""
          echo "=== æ‰§è¡Œç»“æœ ==="
          echo "è„šæœ¬é€€å‡ºä»£ç : $EXIT_CODE"
          echo "ç»“æŸæ—¶é—´: $(date)"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… ç›‘æ§æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ ç›‘æ§æ‰§è¡Œå¤±è´¥"
            exit $EXIT_CODE
          fi
      
      - name: é”™è¯¯å¤„ç†
        if: failure()
        run: |
          echo "âŒ ç›‘æ§ä»»åŠ¡å¤±è´¥"
          echo ""
          echo "å¸¸è§é—®é¢˜:"
          echo "1. æ£€æŸ¥ dusk_monitor.py è„šæœ¬æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯"
          echo "2. ç¡®è®¤æ‰€æœ‰å¿…è¦çš„Pythonåº“éƒ½å·²å®‰è£…"
          echo "3. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®"
          echo "4. å°è¯•æœ¬åœ°è¿è¡Œ: python dusk_monitor.py"
      
      - name: æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… ç›‘æ§ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
          echo "ğŸ”„ ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œ: 1åˆ†é’Ÿå"
          echo "ğŸ“Š è¿è¡ŒID: ${{ github.run_id }}"
