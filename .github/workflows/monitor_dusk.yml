name: DUSKUSDT 1-Minute Monitor

on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # æ­¥éª¤2: è®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # æ­¥éª¤3: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          # å®‰è£…requirements.txtä¸­çš„ä¾èµ–
          if [ -f requirements.txt ]; then
            echo "å®‰è£… requirements.txt ä¸­çš„ä¾èµ–..."
            pip install -r requirements.txt
          else
            echo "æœªæ‰¾åˆ° requirements.txt"
          fi
          
          # å®‰è£…å¸¸ç”¨åº“
          echo "å®‰è£…å¸¸ç”¨åº“..."
          pip install requests python-dotenv schedule pandas ccxt
      
      # æ­¥éª¤4: è¿è¡Œç›‘æ§è„šæœ¬ï¼ˆå…³é”®æ­¥éª¤ï¼‰
      - name: Run DUSKUSDT Monitor
        env:
          DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
          
          # ============================================
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå¿…é¡»ä¸è„šæœ¬ä¸­çš„å˜é‡åä¸€è‡´ï¼‰
          # ============================================
          # è„šæœ¬æœŸæœ›çš„å˜é‡å
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TRADE_SYMBOL: ${{ secrets.TRADE_SYM }}
          
          # å…¶ä»–å¯èƒ½éœ€è¦çš„ç¯å¢ƒå˜é‡
          PYTHONUNBUFFERED: '1'  # ç¡®ä¿å®æ—¶è¾“å‡ºæ—¥å¿—
        run: |
          echo "ğŸš€ å¯åŠ¨ DUSKUSDT 1åˆ†é’Ÿç›‘æ§..."
          echo "ğŸ“… æ—¶é—´: $(date)"
          echo "ğŸ› è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
          echo "ğŸ“ å·¥ä½œç›®å½•: $(pwd)"
          echo ""
          
          # éªŒè¯è„šæœ¬æ–‡ä»¶å­˜åœ¨
          if [ ! -f "dusk_monitor.py" ]; then
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° dusk_monitor.py æ–‡ä»¶"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°è„šæœ¬æ–‡ä»¶: dusk_monitor.py"
          echo ""
          
          # éªŒè¯ç¯å¢ƒå˜é‡è®¾ç½®ï¼ˆä¸æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯ï¼‰
          echo "ğŸ”§ ç¯å¢ƒå˜é‡æ£€æŸ¥:"
          
          if [ -n "$TG_TOKEN" ]; then
            echo "âœ… TG_TOKEN: å·²è®¾ç½® (é•¿åº¦: ${#TG_TOKEN} å­—ç¬¦)"
          else
            echo "âŒ TG_TOKEN: æœªè®¾ç½®"
          fi
          
          if [ -n "$TG_CHAT_ID" ]; then
            echo "âœ… TG_CHAT_ID: å·²è®¾ç½® (å€¼: $TG_CHAT_ID)"
          else
            echo "âŒ TG_CHAT_ID: æœªè®¾ç½®"
          fi
          
          if [ -n "$TRADE_SYMBOL" ]; then
            echo "âœ… TRADE_SYMBOL: $TRADE_SYMBOL"
          else
            echo "âŒ TRADE_SYMBOL: æœªè®¾ç½®"
            echo "ğŸ’¡ æç¤º: æ£€æŸ¥GitHub Secretsä¸­æ˜¯å¦æœ‰ TRADE_SYM"
          fi
          echo ""
          
          # æ˜¾ç¤ºPythonç‰ˆæœ¬
          echo "ğŸ Pythonç‰ˆæœ¬:"
          python --version
          echo ""
          
          # æ£€æŸ¥è„šæœ¬ä¸­å®é™…ä½¿ç”¨çš„å˜é‡
          echo "ğŸ” æ£€æŸ¥è„šæœ¬ä¸­çš„ç¯å¢ƒå˜é‡å¼•ç”¨..."
          grep -n "os\.getenv\|os\.environ" dusk_monitor.py | head -10
          echo ""
          
          # è¿è¡Œç›‘æ§è„šæœ¬
          echo "â–¶ï¸ å¼€å§‹æ‰§è¡Œç›‘æ§è„šæœ¬..."
          echo "----------------------------------------"
          
          # è¿è¡Œè„šæœ¬å¹¶æ•è·è¾“å‡º
          python dusk_monitor.py
          
          EXIT_CODE=$?
          echo "----------------------------------------"
          echo ""
          echo "ğŸ“Š è„šæœ¬é€€å‡ºä»£ç : $EXIT_CODE"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥"
            echo ""
            echo "ğŸ’¡ è°ƒè¯•å»ºè®®:"
            echo "1. æ£€æŸ¥è„šæœ¬ä¸­ç¯å¢ƒå˜é‡çš„ä½¿ç”¨æ–¹å¼"
            echo "2. ç¡®è®¤è„šæœ¬æ˜¯å¦éœ€è¦å…¶ä»–ç¯å¢ƒå˜é‡"
            echo "3. å°è¯•æœ¬åœ°è¿è¡Œ: python dusk_monitor.py"
          fi
          
          echo "â° ç»“æŸæ—¶é—´: $(date)"
      
      # æ­¥éª¤5: é”™è¯¯å¤„ç†
      - name: Handle Failure
        if: failure()
        run: |
          echo "âŒ ç›‘æ§ä»»åŠ¡å¤±è´¥!"
          echo ""
          echo "è¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®:"
          echo "1. ç¡®è®¤GitHub Secretsä¸­çš„å€¼æ­£ç¡®:"
          echo "   - TG_TOKEN: Telegramæœºå™¨äººä»¤ç‰Œ"
          echo "   - TG_CHAT_ID: TelegramèŠå¤©ID"
          echo "   - TRADE_SYM: äº¤æ˜“å¯¹ç¬¦å·ï¼ˆå¦‚ DUSKUSDTï¼‰"
          echo ""
          echo "2. æ£€æŸ¥è„šæœ¬ä¸­å¦‚ä½•è¯»å–ç¯å¢ƒå˜é‡:"
          echo "   åº”è¯¥ä½¿ç”¨: os.getenv('TG_TOKEN')"
          echo "   è€Œä¸æ˜¯: os.getenv('TELEGRAM_BOT_TOKEN')"
